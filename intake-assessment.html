<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 3: Intake Assessment - Internal Dosimetry Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Glossary System -->
    <script src="glossary-definitions.js"></script>
    <script src="glossary-modal.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }
        
        /* Progress tracking styles */
        .progress-bar {
            background: linear-gradient(to right, #10b981, #06b6d4, #3b82f6, #8b5cf6, #ef4444);
            transition: width 0.3s ease;
        }
        .progress-section {
            transition: all 0.3s ease;
        }
        .progress-section.completed {
            border-left-color: #2563eb; /* Blue for this module */
            background-color: #eff6ff;
        }
        
        /* Progressive Disclosure Styles */
        .foundation-content {
            display: block;
        }
        .deep-dive-content {
            border-left: 3px solid #7c3aed;
            padding-left: 12px;
            background-color: #f5f3ff;
            border-radius: 6px;
            margin: 8px 0;
        }
        .rabbit-hole-content {
            border-left: 3px solid #be185d;
            padding-left: 12px;
            background-color: #fdf2f8;
            border-radius: 6px;
            margin: 8px 0;
        }
        .dive-deeper-btn {
            color: #7c3aed;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #7c3aed;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        .dive-deeper-btn:hover {
            background-color: #7c3aed;
            color: white;
            transform: translateX(2px);
        }
        .rabbit-hole-btn {
            color: #be185d;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #be185d;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        .rabbit-hole-btn:hover {
            background-color: #be185d;
            color: white;
            transform: translateX(2px);
        }
        .glossary-term {
            color: #d97706;
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .glossary-term:hover {
            color: #92400e;
            background-color: #fef3c7;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Quiz styles */
        .quiz-question {
            display: none;
        }
        .quiz-question.active {
            display: block;
        }
        .quiz-option {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .quiz-option:hover {
            background-color: #f3f4f6;
        }
        .quiz-option.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #16a34a;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2;
            border-color: #dc2626;
        }

        /* Ensure sidebar layout works */
        .flex.gap-8 {
            display: flex !important;
            gap: 2rem !important;
            align-items: flex-start !important;
        }
        .flex-1 {
            flex: 1 !important;
            min-width: 0 !important;
        }
        .w-80 {
            width: 20rem !important;
            flex-shrink: 0 !important;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Progress Tracker -->
    <div class="bg-white border-b border-stone-200 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-stone-600">Module 3 Progress:</span>
                    <div class="w-32 bg-stone-200 rounded-full h-2">
                        <div id="overall-progress" class="progress-bar h-2 rounded-full" style="width: 0%; background-color: #3b82f6;"></div>
                    </div>
                    <span id="progress-text" class="text-sm text-stone-600">0% Complete</span>
                </div>
                <button onclick="resetProgress()" class="text-xs text-red-600 hover:text-red-700 font-medium">
                    Reset Progress
                </button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-md sticky top-8 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-stone-500">
                        <a href="index.html" class="hover:text-blue-600 font-medium">Learning Hub</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <a href="foundations.html" class="hover:text-blue-600 font-medium">Module 1</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <a href="bioassay.html" class="hover:text-blue-600 font-medium">Module 2</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        <span class="text-blue-600 font-medium">Module 3: Intake Assessment</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="dose-calculation.html" class="hidden md:inline-flex items-center text-stone-600 hover:text-blue-600 font-medium">
                        Next: Dose Calculation
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </a>
                </div>
            </div>
            <div class="border-t border-stone-200 pt-4">
                <h1 class="text-3xl font-bold text-stone-900 mb-2">Module 3: Intake Assessment - From Measurement to Intake</h1>
                <p class="text-stone-600 mb-4">Learn how to work backwards from bioassay data to estimate the amount of radioactive material taken into the body.</p>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Main Content -->
            
            <!-- Module Introduction -->
            <div class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-400">
                <h2 class="text-2xl font-bold mb-4 text-blue-800">🎯 Module 3 Learning Objectives</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="space-y-2">
                        <h3 class="font-semibold text-blue-800">By the end of this module, you will:</h3>
                        <ul class="text-blue-700 text-sm space-y-1">
                            <li>✓ Understand the role of biokinetic models</li>
                            <li>✓ Grasp the concept of Intake Retention Functions (IRFs)</li>
                            <li>✓ Know how to work backwards from measurement to intake</li>
                            <li>✓ Appreciate the challenges of unknown intake timing</li>
                            <li>✓ Be familiar with software tools like IMBA</li>
                        </ul>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-blue-800 mb-2">🧩 The Central Puzzle</h3>
                        <p class="text-sm text-blue-600">Intake assessment is the critical step that connects what we can measure (bioassay) to what we need to know (intake) to calculate dose.</p>
                    </div>
                </div>
            </div>

            <!-- Section 1: Biokinetic Models & IRF Concepts -->
            <section id="section-1" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-stone-900">1. Biokinetic Models & IRF Concepts</h2>
                    <div class="flex items-center space-x-2">
                        <div id="section-1-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                            <span class="text-xs font-bold text-stone-400">1</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400 mb-4">
                        <p class="text-blue-800 font-medium">Definition: A <span class="glossary-term" data-term="biokinetic-model">Biokinetic Model</span> is a mathematical description of how a substance is taken up, distributed, and retained in the body's organs and tissues, and how it is excreted.</p>
                    </div>
                    <p class="text-lg mb-4">These models, developed by organizations like the ICRP, are our best representation of human physiology. They tell us where a radionuclide will go in the body and how long it will stay there.</p>
                    
                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-200 mb-4">
                        <h3 class="font-bold text-amber-800 mb-2">🔑 Key Insight</h3>
                        <p class="text-amber-700">We can't directly measure the intake. We use biokinetic models to predict what our measurements *should* be for a given intake, and then work backwards.</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Introducing the Intake Retention Function (IRF)</h3>
                    <p class="mb-4">The <span class="glossary-term" data-term="irf">Intake Retention Function (IRF)</span> is the output of a biokinetic model. It's a function that tells you the fraction of the initial intake that is expected to be in a specific organ or in the total body at any time after the intake.</p>
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                        <h4 class="font-bold text-indigo-800 mb-2">IRF = Fraction of Intake Remaining at Time (t)</h4>
                        <p class="text-indigo-700 text-sm">For example, an IRF for Iodine-131 in the thyroid might tell you that at 24 hours post-intake, 30% of the iodine is in the thyroid. This is a powerful predictive tool!</p>
                    </div>
                </div>

                <button class="dive-deeper-btn mb-4" onclick="toggleDeepDive('irf-details')">
                    🔍 Dive Deeper: IRF Types & Mathematical Representation
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="irf-details" class="deep-dive-content hidden mb-4">
                    <h4 class="font-semibold mb-3">Types of IRFs</h4>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded border border-purple-300">
                            <h5 class="font-semibold text-purple-800 mb-2">Retention IRF</h5>
                            <p class="text-purple-700 text-sm mb-2">R(t) = fraction of intake retained in organ/body at time t</p>
                            <p class="text-purple-600 text-xs">Used for in vivo measurements (whole body counting, organ counting)</p>
                        </div>
                        <div class="bg-white p-4 rounded border border-purple-300">
                            <h5 class="font-semibold text-purple-800 mb-2">Excretion IRF</h5>
                            <p class="text-purple-700 text-sm mb-2">E(t) = cumulative fraction of intake excreted by time t</p>
                            <p class="text-purple-600 text-xs">Used for in vitro measurements (urine, fecal analysis)</p>
                        </div>
                        <div class="bg-white p-4 rounded border border-purple-300">
                            <h5 class="font-semibold text-purple-800 mb-2">Excretion Rate IRF</h5>
                            <p class="text-purple-700 text-sm mb-2">e(t) = fraction of intake excreted per unit time at time t</p>
                            <p class="text-purple-600 text-xs">Used when measuring excretion rate rather than cumulative excretion</p>
                        </div>
                    </div>
                </div>

                <button class="rabbit-hole-btn mb-4" onclick="toggleDeepDive('compartment-models')">
                    🐰 Rabbit Hole: Compartment Model Mathematics
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="compartment-models" class="rabbit-hole-content hidden mb-4">
                    <h4 class="font-semibold mb-3">Multi-Compartment Model Mathematics</h4>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded border border-pink-300">
                            <h5 class="font-semibold text-pink-800 mb-2">Simple Two-Compartment Model</h5>
                            <p class="text-pink-700 text-sm mb-2">For a substance that moves from compartment 1 to compartment 2:</p>
                            <div class="bg-pink-50 p-3 rounded font-mono text-sm">
                                <p>dN₁/dt = -λ₁₂N₁ - λ₁ₑN₁</p>
                                <p>dN₂/dt = λ₁₂N₁ - λ₂ₑN₂</p>
                            </div>
                            <p class="text-pink-600 text-xs mt-2">Where λ values are transfer constants between compartments and to excretion</p>
                        </div>
                        <div class="bg-white p-4 rounded border border-pink-300">
                            <h5 class="font-semibold text-pink-800 mb-2">Solution for Retention</h5>
                            <p class="text-pink-700 text-sm mb-2">The solution involves exponential terms:</p>
                            <div class="bg-pink-50 p-3 rounded font-mono text-sm">
                                <p>R(t) = A₁e^(-λ₁t) + A₂e^(-λ₂t) + ...</p>
                            </div>
                            <p class="text-pink-600 text-xs mt-2">Each exponential represents a different biological process (fast vs slow clearance)</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button id="section-1-complete-btn" onclick="markSectionComplete('section-1')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                        Mark Section Complete
                    </button>
                    <button id="section-1-reset-btn" onclick="unmarkSection('section-1')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                        Reset Section
                    </button>
                </div>
            </section>

            <!-- Section 2: Working Backwards: From Measurement to Intake -->
            <section id="section-2" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-stone-900">2. Working Backwards: From Measurement to Intake</h2>
                    <div class="flex items-center space-x-2">
                        <div id="section-2-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                            <span class="text-xs font-bold text-stone-400">2</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <p class="text-lg mb-4">This is the core calculation in intake assessment. We use the IRF to solve for the unknown intake amount.</p>
                    <div class="bg-green-50 p-6 rounded-lg border border-green-300 text-center">
                        <h3 class="text-xl font-bold text-green-800 mb-2">The Fundamental Equation</h3>
                        <p class="text-2xl font-mono text-green-900 bg-white p-4 rounded-md shadow-inner">
                            Intake = Measurement / IRF(t)
                        </p>
                        <p class="text-green-700 mt-3 text-sm">Where 't' is the time between the intake and the measurement.</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Example Calculation</h3>
                    <div class="bg-white p-4 rounded-lg border border-stone-200">
                        <p class="mb-2"><strong>Scenario:</strong> A worker has a thyroid measurement of <strong>1,000 Bq</strong> of I-131, taken <strong>48 hours</strong> after a known incident.</p>
                        <p class="mb-2"><strong>From ICRP Models:</strong> We look up the IRF for I-131 in the thyroid at 48 hours. Let's say the value is <strong>0.25</strong> (meaning 25% of the intake is in the thyroid at 48h).</p>
                        <hr class="my-3">
                        <p class="font-mono text-lg">Intake = 1,000 Bq / 0.25</p>
                        <p class="font-bold text-2xl text-blue-600 mt-2">Intake = 4,000 Bq</p>
                    </div>
                </div>

                <button class="dive-deeper-btn mb-4" onclick="toggleDeepDive('multiple-measurements')">
                    🔍 Dive Deeper: Multiple Measurements & Statistical Fitting
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="multiple-measurements" class="deep-dive-content hidden mb-4">
                    <h4 class="font-semibold mb-3">Handling Multiple Measurements</h4>
                    <p class="mb-3">In practice, we often have multiple bioassay measurements over time. This creates a system of equations:</p>
                    <div class="bg-white p-4 rounded border border-purple-300 mb-3">
                        <div class="font-mono text-sm space-y-1">
                            <p>M₁ = I × IRF(t₁)</p>
                            <p>M₂ = I × IRF(t₂)</p>
                            <p>M₃ = I × IRF(t₃)</p>
                            <p>...</p>
                        </div>
                        <p class="text-purple-600 text-xs mt-2">Where M = measurement, I = intake (unknown), t = time</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded">
                        <h5 class="font-semibold text-purple-800 mb-2">Maximum Likelihood Estimation</h5>
                        <p class="text-purple-700 text-sm">Software like IMBA uses statistical methods to find the intake value that best fits all measurements, accounting for measurement uncertainties.</p>
                    </div>
                </div>

                <div class="mt-6">
                    <button id="section-2-complete-btn" onclick="markSectionComplete('section-2')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                        Mark Section Complete
                    </button>
                    <button id="section-2-reset-btn" onclick="unmarkSection('section-2')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                        Reset Section
                    </button>
                </div>
            </section>

            <!-- Section 3: Unknown Intake Timing Challenges -->
            <section id="section-3" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-stone-900">3. The Challenge of Unknown Intake Timing</h2>
                    <div class="flex items-center space-x-2">
                        <div id="section-3-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                            <span class="text-xs font-bold text-stone-400">3</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400 mb-4">
                        <h3 class="font-bold text-red-800 mb-2">🚨 The Biggest Problem in Internal Dosimetry</h3>
                        <p class="text-red-700">In most real-world scenarios, especially from routine monitoring, we don't know *when* the intake occurred. This introduces significant uncertainty.</p>
                    </div>
                    <p class="text-lg mb-4">The IRF value changes dramatically with time. If you don't know the time (t), you can't pick the right IRF value. This is where assumptions become necessary.</p>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Common Assumptions for Unknown Timing</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="font-bold text-yellow-800 mb-2">Midpoint Assumption</h4>
                            <p class="text-yellow-700 text-sm">Assume the intake occurred at the midpoint of the monitoring period (e.g., if monitoring is every 30 days, assume intake on day 15). This is a common regulatory practice.</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h4 class="font-bold text-orange-800 mb-2">Most Conservative Assumption</h4>
                            <p class="text-orange-700 text-sm">Choose the intake time that results in the *highest possible* calculated intake. This is done by finding the time 't' where the IRF value is at its minimum during the possible intake window.</p>
                        </div>
                    </div>
                </div>

                <button class="dive-deeper-btn mb-4" onclick="toggleDeepDive('timing-uncertainty')">
                    🔍 Dive Deeper: Quantifying Timing Uncertainty
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <div id="timing-uncertainty" class="deep-dive-content hidden mb-4">
                    <h4 class="font-semibold mb-3">Impact of Timing Uncertainty on Intake Estimates</h4>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded border border-purple-300">
                            <h5 class="font-semibold text-purple-800 mb-2">Example: Cs-137 Whole Body Counting</h5>
                            <p class="text-purple-700 text-sm mb-2">A routine measurement shows 1000 Bq. Monitoring interval is 30 days.</p>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="bg-purple-50 p-2 rounded">
                                    <strong>If intake was 1 day ago:</strong><br>
                                    IRF ≈ 0.95, Intake = 1053 Bq
                                </div>
                                <div class="bg-purple-50 p-2 rounded">
                                    <strong>If intake was 30 days ago:</strong><br>
                                    IRF ≈ 0.75, Intake = 1333 Bq
                                </div>
                            </div>
                            <p class="text-purple-600 text-xs mt-2">27% difference in intake estimate due to timing uncertainty!</p>
                        </div>
                        <div class="bg-white p-4 rounded border border-purple-300">
                            <h5 class="font-semibold text-purple-800 mb-2">Regulatory Approaches</h5>
                            <ul class="text-purple-700 text-sm space-y-1">
                                <li>• <strong>10 CFR 835:</strong> Use assumptions that maximize dose</li>
                                <li>• <strong>ICRP 78:</strong> Consider most likely intake time</li>
                                <li>• <strong>Bayesian Methods:</strong> Use probability distributions for intake timing</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button id="section-3-complete-btn" onclick="markSectionComplete('section-3')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                        Mark Section Complete
                    </button>
                    <button id="section-3-reset-btn" onclick="unmarkSection('section-3')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                        Reset Section
                    </button>
                </div>
            </section>

            <!-- Section 4: Software Tools (IMBA Overview) -->
            <section id="section-4" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-stone-900">4. Software Tools: An Introduction to IMBA</h2>
                    <div class="flex items-center space-x-2">
                        <div id="section-4-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                            <span class="text-xs font-bold text-stone-400">4</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <p class="text-lg mb-4">Manually calculating intakes is complex, especially with multiple measurements or complex scenarios. Professional software is used to handle this.</p>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 mb-4">
                        <h3 class="font-bold text-purple-800 mb-2">IMBA: Integrated Modules for Bioassay Analysis</h3>
                        <p class="text-purple-700">IMBA is a widely-used software suite that implements ICRP biokinetic models. It allows dosimetrists to input bioassay data and let the software perform the complex calculations.</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">What IMBA Does</h3>
                    <ul class="list-disc list-inside space-y-2 text-stone-700">
                        <li>Contains a library of ICRP models and IRFs for hundreds of radionuclides.</li>
                        <li>Can handle multiple bioassay measurements over time.</li>
                        <li>Uses statistical methods (like Maximum Likelihood Estimation) to find the best-fit intake scenario.</li>
                        <li>Can model different intake patterns (acute, chronic).</li>
                        <li>Calculates intake, organ doses, and committed effective dose.</li>
                    </ul>
                </div>

                <div class="mt-6">
                    <button id="section-4-complete-btn" onclick="markSectionComplete('section-4')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                        Mark Section Complete
                    </button>
                    <button id="section-4-reset-btn" onclick="unmarkSection('section-4')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                        Reset Section
                    </button>
                </div>
            </section>

            <!-- Knowledge Check Quiz -->
            <section id="knowledge-check" class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                <h2 class="text-2xl font-bold mb-4 text-blue-800">🧠 Knowledge Check</h2>
                <p class="text-blue-700 mb-6">Test your understanding of intake assessment concepts before moving to dose calculation!</p>
                
                <div id="quiz-container">
                    <!-- Quiz Question 1 -->
                    <div id="question-1" class="quiz-question active">
                        <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 1 of 4</h3>
                        <p class="text-stone-700 mb-4">You have a urine measurement of 50 Bq of Pu-239 taken 7 days after a suspected intake. The IRF for Pu-239 urine excretion at 7 days is 0.001 (meaning 0.1% of intake is excreted by day 7). What is the estimated intake?</p>
                        <div class="space-y-2">
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="A">
                                <span class="font-semibold">A)</span> 0.05 Bq
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="B">
                                <span class="font-semibold">B)</span> 500 Bq
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="C">
                                <span class="font-semibold">C)</span> 5,000 Bq
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="D">
                                <span class="font-semibold">D)</span> 50,000 Bq
                            </div>
                        </div>
                        <div id="explanation-1" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800 text-sm"><strong>Correct!</strong> Using the fundamental equation: Intake = Measurement / IRF(t) = 50 Bq / 0.001 = 50,000 Bq. This demonstrates how a small measurement can indicate a large intake for poorly-excreted materials like plutonium.</p>
                        </div>
                    </div>

                    <!-- Quiz Question 2 -->
                    <div id="question-2" class="quiz-question">
                        <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 2 of 4</h3>
                        <p class="text-stone-700 mb-4">A worker's routine bioassay shows positive results, but the intake timing is unknown. The sample was taken on January 30th, and the previous negative sample was on January 1st. Which approach would likely give the most conservative (highest) intake estimate?</p>
                        <div class="space-y-2">
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="A">
                                <span class="font-semibold">A)</span> Assume intake occurred on January 1st (earliest possible time)
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="B">
                                <span class="font-semibold">B)</span> Assume intake occurred on January 15th (midpoint)
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="C">
                                <span class="font-semibold">C)</span> Assume intake occurred on January 29th (just before sampling)
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="D">
                                <span class="font-semibold">D)</span> It doesn't matter - the intake estimate will be the same
                            </div>
                        </div>
                        <div id="explanation-2" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800 text-sm"><strong>Correct!</strong> Assuming intake occurred at the earliest possible time (January 1st) gives the most conservative estimate. More time means more material has been excreted, so IRF(t) is lower. Since Intake = Measurement / IRF(t), a smaller IRF results in a larger calculated intake.</p>
                        </div>
                    </div>

                    <!-- Quiz Question 3 -->
                    <div id="question-3" class="quiz-question">
                        <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 3 of 4</h3>
                        <p class="text-stone-700 mb-4">Why are biokinetic models and IRFs essential for intake assessment rather than simply using simple ratios or rules of thumb?</p>
                        <div class="space-y-2">
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="A">
                                <span class="font-semibold">A)</span> They make calculations more complex and impressive
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="B">
                                <span class="font-semibold">B)</span> Because human physiology varies dramatically between individuals
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="C">
                                <span class="font-semibold">C)</span> Because retention and excretion patterns are radionuclide-specific and time-dependent
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="D">
                                <span class="font-semibold">D)</span> They are required by regulation but not scientifically necessary
                            </div>
                        </div>
                        <div id="explanation-3" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800 text-sm"><strong>Correct!</strong> Each radionuclide has unique chemical and physical properties that determine how it behaves in the body. Iodine goes to the thyroid, plutonium deposits in bone and liver, cesium distributes throughout soft tissue. These patterns change over time due to biological and radioactive decay. IRFs capture this complexity.</p>
                        </div>
                    </div>

                    <!-- Quiz Question 4 -->
                    <div id="question-4" class="quiz-question">
                        <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 4 of 4</h3>
                        <p class="text-stone-700 mb-4">What is the primary advantage of using professional software like IMBA over manual calculations for intake assessment?</p>
                        <div class="space-y-2">
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="A">
                                <span class="font-semibold">A)</span> It's faster to get results
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="B">
                                <span class="font-semibold">B)</span> It can handle multiple measurements and use statistical fitting to find the best intake scenario
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="C">
                                <span class="font-semibold">C)</span> It eliminates all uncertainty in the results
                            </div>
                            <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="D">
                                <span class="font-semibold">D)</span> It's required by all regulatory agencies
                            </div>
                        </div>
                        <div id="explanation-4" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800 text-sm"><strong>Correct!</strong> IMBA can analyze multiple bioassay measurements over time and use statistical methods like Maximum Likelihood Estimation to find the intake pattern that best fits all the data. This is far more sophisticated than single-measurement manual calculations and provides better estimates when multiple data points are available.</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6">
                    <div class="flex space-x-2">
                        <button id="prev-question" class="px-4 py-2 bg-stone-500 text-white rounded hover:bg-stone-600 transition-colors disabled:opacity-50" disabled>
                            Previous
                        </button>
                        <button onclick="resetQuiz()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                            Reset Quiz
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <span id="question-indicator" class="px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm">Question 1 of 4</span>
                    </div>
                    <button id="next-question" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        Next Question
                    </button>
                </div>

                <div id="quiz-complete" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">🎉 Module 3 Complete!</h3>
                    <p class="text-blue-700 mb-4">Excellent work! You now understand how bioassay measurements connect to intake estimates. You're ready to learn the final step: converting intake to dose.</p>
                    <a href="dose-calculation.html" class="inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors">
                        Continue to Module 4: Dose Calculation →
                    </a>
                </div>
            </section>

            <!-- Module Summary -->
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                <h2 class="text-xl font-bold text-blue-800 mb-3">📚 Module 3 Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <h3 class="font-semibold text-blue-800 mb-2">Key Concepts Mastered:</h3>
                        <ul class="text-blue-700 space-y-1">
                            <li>• Biokinetic models and IRF concepts</li>
                            <li>• Working backwards from measurement to intake</li>
                            <li>• Challenges of unknown intake timing</li>
                            <li>• Role of professional software tools</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-blue-800 mb-2">Ready for Next Module:</h3>
                        <p class="text-blue-700">You now understand how to estimate intake from bioassay data. Next, we'll explore how intake estimates are converted into dose calculations for regulatory compliance.</p>
                    </div>
                </div>
    </main>

    <script>
        // Progress tracking
        let sectionProgress = {
            'section-1': false,
            'section-2': false,
            'section-3': false,
            'section-4': false,
            'quiz': false
        };

        // Quiz state
        let currentQuestion = 1;
        let quizAnswers = {};

        // Load progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem('intake-assessment-progress');
            if (saved) {
                sectionProgress = { ...sectionProgress, ...JSON.parse(saved) };
                updateProgressDisplay();
                updateSectionVisuals();
            }
        }

        // Save progress to localStorage
        function saveProgress() {
            localStorage.setItem('intake-assessment-progress', JSON.stringify(sectionProgress));
        }

        // Mark section as complete
        function markSectionComplete(sectionId) {
            sectionProgress[sectionId] = true;
            saveProgress();
            updateProgressDisplay();
            updateSectionVisuals();
            
            // Visual feedback
            const section = document.getElementById(sectionId);
            section.classList.add('completed');
            
            // Animate status indicator
            const status = document.getElementById(sectionId + '-status');
            status.innerHTML = '<svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
            status.style.backgroundColor = '#2563eb';
            status.style.borderColor = '#2563eb';
            
            // Update button states
            const completeBtn = document.getElementById(sectionId + '-complete-btn');
            const resetBtn = document.getElementById(sectionId + '-reset-btn');
            
            if (completeBtn) {
                completeBtn.classList.add('bg-stone-400', 'cursor-not-allowed');
                completeBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                completeBtn.disabled = true;
                completeBtn.innerHTML = '✓ Section Complete';
            }
            
            if (resetBtn) {
                resetBtn.classList.remove('hidden');
            }
        }

        // Unmark section (allow users to reset individual sections)
        function unmarkSection(sectionId) {
            sectionProgress[sectionId] = false;
            saveProgress();
            updateProgressDisplay();
            updateSectionVisuals();
            
            // Reset visual state
            const section = document.getElementById(sectionId);
            section.classList.remove('completed');
            
            // Reset status indicator
            const status = document.getElementById(sectionId + '-status');
            const sectionNumber = sectionId.split('-')[1];
            status.innerHTML = `<span class="text-xs font-bold text-stone-400">${sectionNumber}</span>`;
            status.style.backgroundColor = '';
            status.style.borderColor = '#d1d5db';
            
            // Reset button states
            const completeBtn = document.getElementById(sectionId + '-complete-btn');
            const resetBtn = document.getElementById(sectionId + '-reset-btn');
            
            if (completeBtn) {
                completeBtn.classList.remove('bg-stone-400', 'cursor-not-allowed');
                completeBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                completeBtn.disabled = false;
                completeBtn.innerHTML = 'Mark Section Complete';
            }
            
            if (resetBtn) {
                resetBtn.classList.add('hidden');
            }
        }

        // Reset all progress
        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress for this module? This cannot be undone.')) {
                // Reset progress object
                Object.keys(sectionProgress).forEach(key => {
                    sectionProgress[key] = false;
                });
                
                // Reset quiz state
                currentQuestion = 1;
                quizAnswers = {};
                
                // Save and update display
                saveProgress();
                updateProgressDisplay();
                updateSectionVisuals();
                
                // Reset quiz interface if visible
                if (!document.getElementById('quiz-complete').classList.contains('hidden')) {
                    document.getElementById('quiz-container').style.display = 'block';
                    document.getElementById('quiz-complete').classList.add('hidden');
                    
                    // Reset to first question
                    document.querySelectorAll('.quiz-question').forEach(q => q.classList.remove('active'));
                    document.getElementById('question-1').classList.add('active');
                    
                    // Reset question indicators
                    document.querySelectorAll('[id$="-indicator"]').forEach(indicator => {
                        indicator.classList.remove('bg-blue-500', 'bg-green-500');
                        indicator.classList.add('bg-stone-300');
                    });
                    document.getElementById('q1-indicator').classList.add('bg-blue-500');
                    
                    // Reset navigation buttons
                    document.getElementById('prev-question').disabled = true;
                    document.getElementById('next-question').disabled = true;
                    document.getElementById('next-question').textContent = 'Next';
                    
                    // Clear all quiz selections and explanations
                    document.querySelectorAll('.quiz-option').forEach(option => {
                        option.classList.remove('selected', 'correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="explanation-"]').forEach(explanation => {
                        explanation.classList.add('hidden');
                    });
                }
                
                alert('Progress has been reset successfully!');
            }
        }

        // Toggle sidebar visibility
        function toggleSidebar() {
            const content = document.getElementById('sidebar-content');
            const toggle = document.getElementById('sidebar-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '−';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        // Reset all progress (alternative function for sidebar)
        function resetAllProgress() {
            resetProgress();
        }

        // Reset quiz only
        function resetQuizOnly() {
            if (confirm('Reset quiz progress? This will clear your quiz answers and allow you to retake it.')) {
                sectionProgress['quiz'] = false;
                currentQuestion = 1;
                quizAnswers = {};
                
                saveProgress();
                updateProgressDisplay();
                updateSectionVisuals();
                
                // Reset quiz interface if visible
                if (!document.getElementById('quiz-complete').classList.contains('hidden')) {
                    document.getElementById('quiz-container').style.display = 'block';
                    document.getElementById('quiz-complete').classList.add('hidden');
                    
                    // Reset to first question
                    document.querySelectorAll('.quiz-question').forEach(q => q.classList.remove('active'));
                    document.getElementById('question-1').classList.add('active');
                    
                    // Reset navigation buttons
                    document.getElementById('prev-question').disabled = true;
                    document.getElementById('next-question').disabled = true;
                    document.getElementById('next-question').textContent = 'Next';
                    
                    // Clear all quiz selections and explanations
                    document.querySelectorAll('.quiz-option').forEach(option => {
                        option.classList.remove('selected', 'correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="explanation-"]').forEach(explanation => {
                        explanation.classList.add('hidden');
                    });
                }
            }
        }

        // Update sidebar progress display
        function updateSidebarProgress() {
            const completed = Object.values(sectionProgress).filter(Boolean).length;
            const total = Object.keys(sectionProgress).length;
            
            // Update overall progress in sidebar
            const sidebarProgress = document.getElementById('overall-progress-sidebar');
            if (sidebarProgress) {
                sidebarProgress.textContent = `${completed}/${total} Complete`;
            }
            
            // Update section checklist
            const checklist = document.getElementById('section-checklist');
            if (checklist) {
                checklist.innerHTML = `
                    <div class="flex items-center justify-between py-1">
                        <div class="flex items-center">
                            <span class="${sectionProgress['section-1'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-1'] ? '✓' : '○'}</span>
                            <span class="ml-2 text-sm">Biokinetic Models & IRFs</span>
                        </div>
                        ${sectionProgress['section-1'] ? '<button onclick="unmarkSection(\'section-1\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <div class="flex items-center">
                            <span class="${sectionProgress['section-2'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-2'] ? '✓' : '○'}</span>
                            <span class="ml-2 text-sm">Working Backwards</span>
                        </div>
                        ${sectionProgress['section-2'] ? '<button onclick="unmarkSection(\'section-2\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <div class="flex items-center">
                            <span class="${sectionProgress['section-3'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-3'] ? '✓' : '○'}</span>
                            <span class="ml-2 text-sm">Timing Challenges</span>
                        </div>
                        ${sectionProgress['section-3'] ? '<button onclick="unmarkSection(\'section-3\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <div class="flex items-center">
                            <span class="${sectionProgress['section-4'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-4'] ? '✓' : '○'}</span>
                            <span class="ml-2 text-sm">Software Tools</span>
                        </div>
                        ${sectionProgress['section-4'] ? '<button onclick="unmarkSection(\'section-4\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <div class="flex items-center">
                            <span class="${sectionProgress['quiz'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['quiz'] ? '✓' : '○'}</span>
                            <span class="ml-2 text-sm">Knowledge Check Quiz</span>
                        </div>
                        ${sectionProgress['quiz'] ? '<button onclick="resetQuizOnly()" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                    </div>
                `;
            }
        }

        // Update progress display
        function updateProgressDisplay() {
            const completed = Object.values(sectionProgress).filter(Boolean).length;
            const total = Object.keys(sectionProgress).length;
            const percentage = Math.round((completed / total) * 100);
            
            document.getElementById('overall-progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = percentage + '% Complete';
            
            // Also update sidebar
            updateSidebarProgress();
        }

        // Update section visual states
        function updateSectionVisuals() {
            Object.keys(sectionProgress).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const status = document.getElementById(sectionId + '-status');
                const completeBtn = document.getElementById(sectionId + '-complete-btn');
                const resetBtn = document.getElementById(sectionId + '-reset-btn');
                
                if (sectionProgress[sectionId]) {
                    if (section) section.classList.add('completed');
                    if (status) {
                        status.innerHTML = '<svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                        status.style.backgroundColor = '#2563eb';
                        status.style.borderColor = '#2563eb';
                    }
                    if (completeBtn) {
                        completeBtn.classList.add('bg-stone-400', 'cursor-not-allowed');
                        completeBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        completeBtn.disabled = true;
                        completeBtn.innerHTML = '✓ Section Complete';
                    }
                    if (resetBtn) {
                        resetBtn.classList.remove('hidden');
                    }
                } else {
                    if (section) section.classList.remove('completed');
                    if (status) {
                        const sectionNumber = sectionId.split('-')[1];
                        status.innerHTML = `<span class="text-xs font-bold text-stone-400">${sectionNumber}</span>`;
                        status.style.backgroundColor = '';
                        status.style.borderColor = '#d1d5db';
                    }
                    if (completeBtn) {
                        completeBtn.classList.remove('bg-stone-400', 'cursor-not-allowed');
                        completeBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        completeBtn.disabled = false;
                        completeBtn.innerHTML = 'Mark Section Complete';
                    }
                    if (resetBtn) {
                        resetBtn.classList.add('hidden');
                    }
                }
            });
        }

        // Show/hide deep dive content
        function toggleDeepDive(contentId) {
            const content = document.getElementById(contentId);
            content.classList.toggle('hidden');
        }

        // Progress detail modal
        function showProgressDetail() {
            const completed = Object.values(sectionProgress).filter(Boolean).length;
            const total = Object.keys(sectionProgress).length;
            
            const details = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span>Section 1: Biokinetic Models & IRF</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-1'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-1'] ? '✓' : '○'}</span>
                            ${sectionProgress['section-1'] ? '<button onclick="unmarkSection(\'section-1\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Section 2: Measurement to Intake</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-2'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-2'] ? '✓' : '○'}</span>
                            ${sectionProgress['section-2'] ? '<button onclick="unmarkSection(\'section-2\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Section 3: Unknown Timing Challenges</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-3'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-3'] ? '✓' : '○'}</span>
                            ${sectionProgress['section-3'] ? '<button onclick="unmarkSection(\'section-3\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Section 4: Software Tools (IMBA)</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-4'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['section-4'] ? '✓' : '○'}</span>
                            ${sectionProgress['section-4'] ? '<button onclick="unmarkSection(\'section-4\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Knowledge Check Quiz</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['quiz'] ? 'text-blue-600' : 'text-stone-400'}">${sectionProgress['quiz'] ? '✓' : '○'}</span>
                            ${sectionProgress['quiz'] ? '<button onclick="resetQuizOnly()" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <hr class="border-stone-200">
                    <div class="flex justify-between font-semibold">
                        <span>Overall Progress</span>
                        <span class="text-blue-600">${completed}/${total} (${Math.round((completed/total)*100)}%)</span>
                    </div>
                    <div class="mt-4 pt-3 border-t border-stone-200">
                        <button onclick="resetProgress(); closeProgressModal();" class="w-full bg-red-50 text-red-700 px-3 py-2 rounded border border-red-200 hover:bg-red-100 transition-colors text-sm">
                            Reset All Progress
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('progressDetails').innerHTML = details;
            document.getElementById('progressModal').classList.remove('hidden');
        }

        function closeProgressModal() {
            document.getElementById('progressModal').classList.add('hidden');
        }

        // Reset quiz only
        function resetQuizOnly() {
            if (confirm('Reset quiz progress? This will clear your quiz answers and allow you to retake it.')) {
                sectionProgress['quiz'] = false;
                currentQuestion = 1;
                quizAnswers = {};
                
                saveProgress();
                updateProgressDisplay();
                updateSectionVisuals();
                
                // Reset quiz interface if visible
                if (!document.getElementById('quiz-complete').classList.contains('hidden')) {
                    document.getElementById('quiz-container').style.display = 'block';
                    document.getElementById('quiz-complete').classList.add('hidden');
                    
                    // Reset to first question
                    document.querySelectorAll('.quiz-question').forEach(q => q.classList.remove('active'));
                    document.getElementById('question-1').classList.add('active');
                    
                    // Reset question indicators
                    document.querySelectorAll('[id$="-indicator"]').forEach(indicator => {
                        indicator.classList.remove('bg-blue-500', 'bg-green-500');
                        indicator.classList.add('bg-stone-300');
                    });
                    document.getElementById('q1-indicator').classList.add('bg-blue-500');
                    
                    // Reset navigation buttons
                    document.getElementById('prev-question').disabled = true;
                    document.getElementById('next-question').disabled = true;
                    document.getElementById('next-question').textContent = 'Next';
                    
                    // Clear all quiz selections and explanations
                    document.querySelectorAll('.quiz-option').forEach(option => {
                        option.classList.remove('selected', 'correct', 'incorrect');
                    });
                    document.querySelectorAll('[id^="explanation-"]').forEach(explanation => {
                        explanation.classList.add('hidden');
                    });
                }
                
                closeProgressModal();
            }
        }

        // Quiz functionality
        // QUIZ SYSTEM - Corrected Template with Blue Color Scheme
        let quizState = {
            currentQuestion: 1,
            totalQuestions: 4,
            answers: {},
            correctAnswers: { 1: 'D', 2: 'A', 3: 'C', 4: 'B' }
        };

        function initializeQuiz() {
            loadQuizState();
            setupQuizEventListeners();
            updateQuizDisplay();
            restoreQuizState();
        }

        function loadQuizState() {
            const saved = localStorage.getItem('intake-assessment-quiz');
            if (saved) {
                const savedState = JSON.parse(saved);
                quizState = { ...quizState, ...savedState };
            }
        }

        function saveQuizState() {
            localStorage.setItem('intake-assessment-quiz', JSON.stringify(quizState));
        }

        function setupQuizEventListeners() {
            // Add click handlers to quiz options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    const question = parseInt(this.getAttribute('data-question'));
                    const selectedOption = this.getAttribute('data-option');
                    selectQuizOption(question, selectedOption);
                });
            });

            // Add handlers to navigation buttons
            const prevBtn = document.getElementById('prev-question');
            const nextBtn = document.getElementById('next-question');
            
            if (prevBtn) prevBtn.addEventListener('click', previousQuestion);
            if (nextBtn) nextBtn.addEventListener('click', nextQuestion);
        }

        function selectQuizOption(questionNum, option) {
            // Store the answer
            quizState.answers[questionNum] = option;
            saveQuizState();
            
            // Remove previous selections for this question
            document.querySelectorAll(`[data-question="${questionNum}"]`).forEach(opt => {
                opt.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
                opt.classList.add('border-stone-300');
            });
            
            // Highlight selected option
            const selectedElement = document.querySelector(`[data-question="${questionNum}"][data-option="${option}"]`);
            const isCorrect = option === quizState.correctAnswers[questionNum];
            
            if (isCorrect) {
                selectedElement.classList.remove('border-stone-300');
                selectedElement.classList.add('border-green-500', 'bg-green-50');
            } else {
                selectedElement.classList.remove('border-stone-300');
                selectedElement.classList.add('border-red-500', 'bg-red-50');
            }
            
            // Show explanation
            showQuizExplanation(questionNum, isCorrect);
        }

        function showQuizExplanation(questionNum, isCorrect) {
            const explanation = document.getElementById(`explanation-${questionNum}`);
            if (!explanation) return;
            
            explanation.classList.remove('hidden');
            
            if (isCorrect) {
                explanation.classList.remove('bg-red-50', 'border-red-200');
                explanation.classList.add('bg-green-50', 'border-green-200');
                const p = explanation.querySelector('p');
                if (p) p.className = 'text-green-800 text-sm';
            } else {
                explanation.classList.remove('bg-green-50', 'border-green-200');
                explanation.classList.add('bg-red-50', 'border-red-200');
                
                const correctAnswer = quizState.correctAnswers[questionNum];
                explanation.innerHTML = `
                    <p class="text-red-800 text-sm">
                        <strong>Incorrect.</strong> The correct answer is <strong>${correctAnswer}</strong>. 
                        ${getCorrectExplanation(questionNum)}
                    </p>
                `;
            }
        }

        function getCorrectExplanation(questionNum) {
            const explanations = {
                1: "Using the fundamental equation: Intake = Measurement / IRF(t) = 50 Bq / 0.001 = 50,000 Bq. This demonstrates how a small measurement can indicate a large intake for poorly-excreted materials like plutonium.",
                2: "Assuming intake occurred at the earliest possible time (January 1st) gives the most conservative estimate. More time means more material has been excreted, so IRF(t) is lower. Since Intake = Measurement / IRF(t), a smaller IRF results in a larger calculated intake.",
                3: "When bioassay measurements are below the MDA, you cannot reliably detect or quantify an intake. The measurement provides no useful information about potential internal contamination.",
                4: "The ICRP biokinetic models provide retention and excretion functions that are fundamental to converting bioassay measurements into intake estimates. These models are the scientific basis for dose assessment."
            };
            return explanations[questionNum] || "Review the material for the correct answer.";
        }

        function previousQuestion() {
            if (quizState.currentQuestion > 1) {
                quizState.currentQuestion--;
                saveQuizState();
                updateQuizDisplay();
            }
        }

        function nextQuestion() {
            if (quizState.currentQuestion < quizState.totalQuestions) {
                quizState.currentQuestion++;
                saveQuizState();
                updateQuizDisplay();
            } else {
                // Quiz complete
                alert('Quiz completed! Great job!');
                markSectionComplete('quiz');
            }
        }

        function updateQuizDisplay() {
            // Hide all explanations when changing questions - CRITICAL FIX
            document.querySelectorAll('[id^="explanation-"]').forEach(exp => {
                exp.classList.add('hidden');
            });
            
            // Update question indicator
            const indicator = document.getElementById('question-indicator');
            if (indicator) {
                indicator.textContent = `Question ${quizState.currentQuestion} of ${quizState.totalQuestions}`;
            }
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prev-question');
            const nextBtn = document.getElementById('next-question');
            
            if (prevBtn) {
                prevBtn.disabled = quizState.currentQuestion === 1;
            }
            
            if (nextBtn) {
                if (quizState.currentQuestion === quizState.totalQuestions) {
                    nextBtn.textContent = 'Finish Quiz';
                } else {
                    nextBtn.textContent = 'Next Question';
                }
            }
            
            // Show/hide questions
            for (let i = 1; i <= quizState.totalQuestions; i++) {
                const questionElement = document.getElementById(`question-${i}`);
                if (questionElement) {
                    if (i === quizState.currentQuestion) {
                        questionElement.style.display = 'block';
                        questionElement.classList.add('active');
                    } else {
                        questionElement.style.display = 'none';
                        questionElement.classList.remove('active');
                    }
                }
            }
        }

        function restoreQuizState() {
            // Restore selected answers and their visual states
            Object.keys(quizState.answers).forEach(questionNum => {
                const answer = quizState.answers[questionNum];
                const isCorrect = answer === quizState.correctAnswers[questionNum];
                
                // Restore visual state
                const selectedElement = document.querySelector(`[data-question="${questionNum}"][data-option="${answer}"]`);
                if (selectedElement) {
                    if (isCorrect) {
                        selectedElement.classList.add('border-green-500', 'bg-green-50');
                    } else {
                        selectedElement.classList.add('border-red-500', 'bg-red-50');
                    }
                }
            });
        }

        function resetQuiz() {
            if (confirm('Are you sure you want to reset the quiz? This will clear all your answers.')) {
                quizState.answers = {};
                quizState.currentQuestion = 1;
                saveQuizState();
                
                // Reset all visual states
                document.querySelectorAll('.quiz-option').forEach(option => {
                    option.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
                    option.classList.add('border-stone-300');
                });
                
                // Hide all explanations
                document.querySelectorAll('[id^="explanation-"]').forEach(exp => {
                    exp.classList.add('hidden');
                });
                
                updateQuizDisplay();
                alert('Quiz has been reset successfully!');
            }
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any old localStorage data that might be causing issues
            if (localStorage.getItem('intake-quiz')) {
                localStorage.removeItem('intake-quiz');
                console.log('Cleared old intake-quiz localStorage data');
            }
            
            loadProgress();
            updateSidebarProgress();
            initializeQuiz(); // Initialize quiz system
            initializeGlossarySystem(); // Initialize glossary modal system
        });

        // Add alias for markSection to work with existing template
        function markSection(sectionId) {
            markSectionComplete(sectionId);
        }

        // Glossary term system now handled by glossary-modal.js
    </script>
</body>
</html>

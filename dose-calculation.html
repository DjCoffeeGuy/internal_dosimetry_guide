<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 4: Dose Calculation - Internal Dosimetry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Glossary System -->
    <script src="glossary-definitions.js"></script>
    <script src="glossary-modal.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Quiz option styles */
        .quiz-option {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .quiz-option:hover {
            background-color: #f3f4f6;
        }
        .quiz-option.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #16a34a;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2;
            border-color: #dc2626;
        }
        
        /* Ensure sidebar layout works */
        .flex.gap-8 {
            display: flex !important;
            gap: 2rem !important;
            align-items: flex-start !important;
        }
        .flex-1 {
            flex: 1 !important;
            min-width: 0 !important;
        }
        .w-80 {
            width: 20rem !important;
            flex-shrink: 0 !important;
        }
        
        /* Progress tracking styles */
        .progress-bar {
            background: linear-gradient(to right, #10b981, #06b6d4, #3b82f6, #8b5cf6, #ef4444);
            transition: width 0.3s ease;
        }
        .progress-section {
            transition: all 0.3s ease;
        }
        .progress-section.completed {
            border-left-color: #7c3aed;
            background-color: #f3e8ff;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Progress Tracker -->
    <div class="bg-white border-b border-stone-200 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-stone-600">Module 4 Progress:</span>
                    <div class="w-32 bg-stone-200 rounded-full h-2">
                        <div id="overall-progress" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <span id="progress-text" class="text-sm text-stone-600">0% Complete</span>
                </div>
                <button onclick="resetProgress()" class="text-xs text-red-600 hover:text-red-700 font-medium">
                    Reset Progress
                </button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-md sticky top-8 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-stone-500">
                        <a href="index.html" class="hover:text-purple-600 font-medium">Learning Hub</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <a href="foundations.html" class="hover:text-purple-600 font-medium">Module 1</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <a href="bioassay.html" class="hover:text-purple-600 font-medium">Module 2</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <a href="intake-assessment.html" class="hover:text-purple-600 font-medium">Module 3</a>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <span class="text-purple-600 font-medium">Module 4: Dose Calculation</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-stone-600 text-sm font-medium">Course Complete!</span>
                </div>
            </div>
            <div class="border-t border-stone-200 pt-4">
                <h1 class="text-3xl font-bold text-stone-900 mb-2">Module 4: Dose Calculation - From Intake to Dose</h1>
                <p class="text-stone-600 mb-4">Complete the internal dosimetry process: converting intake estimates into regulatory-compliant dose assessments</p>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Main Content -->
            
            <!-- Module Introduction -->
            <div class="mb-8 p-6 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg border-l-4 border-purple-400">
                <h2 class="text-2xl font-bold mb-4 text-purple-800">üéØ Module 4 Learning Objectives</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="space-y-2">
                        <h3 class="font-semibold text-purple-800">By the end of this module, you will:</h3>
                        <ul class="text-purple-700 text-sm space-y-1">
                            <li>‚úì Understand dose coefficient derivation from biokinetic models</li>
                            <li>‚úì Master dose calculation principles and regulatory compliance</li>
                            <li>‚úì Apply uncertainty analysis and sensitivity studies</li>
                            <li>‚úì Use software tools and computational methods effectively</li>
                        </ul>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-purple-800 mb-2">üéØ Final Step</h3>
                        <p class="text-sm text-purple-600">This module completes the journey from measurement to dose - the ultimate goal of internal dosimetry.</p>
                    </div>
                </div>
            </div>

            <!-- Section 1: From Models to Dose Coefficients -->
            <section id="section-1" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-stone-900">1. Dose Coefficients and ICRP Framework</h2>
                    <div class="flex items-center space-x-2">
                        <div id="section-1-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                            <span class="text-xs font-bold text-stone-400">1</span>
                        </div>
                    </div>
                </div>
                        </button>
                    </div>
                    
                    <div class="prose max-w-none">
                        <p class="text-stone-700 mb-4">
                            Dose coefficients are the bridge between intake and dose - they represent the committed effective dose 
                            per unit intake for specific radionuclides, chemical forms, and exposure pathways.
                        </p>

                        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 my-6">
                            <div class="flex">
                                <div class="flex-shrink-0">‚ö†Ô∏è</div>
                                <div class="ml-3">
                                    <p class="text-amber-800">
                                        <strong>Key Concept:</strong> Dose coefficients (e-values) are derived from the same biokinetic models 
                                        used for intake assessment, but calculated forward from intake to dose rather than backward from measurements.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">ICRP Dose Coefficient Evolution</h3>
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-stone-50 p-4 rounded border">
                                <h4 class="font-semibold text-stone-700">ICRP 30 Era (1979-1990s)</h4>
                                <ul class="text-sm text-stone-600 mt-2 space-y-1">
                                    <li>‚Ä¢ Simple lung model (D, W, Y classes)</li>
                                    <li>‚Ä¢ 50-year integration period</li>
                                    <li>‚Ä¢ Limited chemical form data</li>
                                    <li>‚Ä¢ Basic GI tract model</li>
                                </ul>
                            </div>
                            <div class="bg-blue-50 p-4 rounded border">
                                <h4 class="font-semibold text-blue-700">ICRP 68/66 Era (1990s-present)</h4>
                                <ul class="text-sm text-blue-600 mt-2 space-y-1">
                                    <li>‚Ä¢ Human Respiratory Tract Model (HRTM)</li>
                                    <li>‚Ä¢ Absorption types (F, M, S)</li>
                                    <li>‚Ä¢ Particle size considerations</li>
                                    <li>‚Ä¢ Enhanced systemic models</li>
                                </ul>
                            </div>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">Dose Coefficient Calculation Process</h3>
                        <div class="bg-stone-100 p-4 rounded border-l-4 border-amber-500 my-4">
                            <p class="font-mono text-center text-lg">
                                e(œÑ) = ‚à´<sub>0</sub><sup>œÑ</sup> Œ£<sub>T</sub> w<sub>T</sub> √ó q<sub>T</sub>(t) √ó dt
                            </p>
                            <p class="text-center text-sm text-stone-600 mt-2">
                                Where: œÑ = 50 years, w<sub>T</sub> = tissue weighting factor, q<sub>T</sub>(t) = retention in tissue T at time t
                            </p>
                        </div>

                        <div class="border border-stone-200 rounded-lg mb-4">
                            <button class="collapse-btn w-full text-left p-4 hover:bg-stone-50" onclick="toggleCollapse('deep-dive-coefficients')">
                                <span class="font-semibold">üî¨ Deep Dive: Step-by-Step Coefficient Derivation</span>
                                <span class="float-right">‚ñº</span>
                            </button>
                            <div id="deep-dive-coefficients" class="collapse-content hidden p-4 border-t border-stone-200">
                                <h4 class="font-semibold mb-3">Detailed Calculation Steps:</h4>
                                <ol class="space-y-3 text-sm">
                                    <li><strong>1. Define Biokinetic Model:</strong> Specify compartments, transfer rates, and clearance pathways</li>
                                    <li><strong>2. Calculate Retention Functions:</strong> Solve differential equations for each tissue compartment</li>
                                    <li><strong>3. Apply Dosimetric Model:</strong> Convert physical retention to absorbed dose using S-values</li>
                                    <li><strong>4. Apply Tissue Weighting:</strong> Use ICRP 103 tissue weighting factors for effective dose</li>
                                    <li><strong>5. Integrate Over Time:</strong> Sum dose contributions over 50-year commitment period</li>
                                </ol>
                                
                                <h4 class="font-semibold mt-4 mb-2">Example: Cesium-137 Ingestion</h4>
                                <div class="bg-gray-50 p-3 rounded text-xs font-mono">
                                    Input: 1 Bq Cs-137 ingestion (Type F)<br>
                                    GI Uptake: f‚ÇÅ = 1.0 (100% absorption)<br>
                                    Systemic Model: Muscle (80%), Other (20%)<br>
                                    Biological Half-life: 70 days<br>
                                    ‚Üí e‚ÇÖ‚ÇÄ = 1.3 √ó 10‚Åª‚Å∏ Sv/Bq
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="section-1-complete-btn" onclick="markSectionComplete('section-1')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                            Mark Section Complete
                        </button>
                        <button id="section-1-reset-btn" onclick="unmarkSection('section-1')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                            Reset Section
                        </button>
                    </div>
                </section>

                <!-- Section 2: Committed Effective Dose -->
                <section id="section-2" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">2. Committed Effective Dose Calculation</h2>
                        <div class="flex items-center space-x-2">
                            <div id="section-2-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                                <span class="text-xs font-bold text-stone-400">2</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prose max-w-none">
                        <p class="text-stone-700 mb-4">
                            Once intake is estimated and appropriate dose coefficients selected, calculating committed effective dose 
                            becomes straightforward - but the devil is in the details of coefficient selection and uncertainty assessment.
                        </p>

                        <div class="bg-stone-100 p-4 rounded border-l-4 border-blue-500 my-4">
                            <p class="font-mono text-center text-xl">
                                CED = I √ó e(œÑ)
                            </p>
                            <p class="text-center text-sm text-stone-600 mt-2">
                                Committed Effective Dose = Intake √ó Dose Coefficient
                            </p>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">Critical Decision Points</h3>
                        
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                                <h4 class="font-semibold text-yellow-700">Chemical Form</h4>
                                <p class="text-sm text-yellow-600 mt-2">
                                    Absorption type (F/M/S for inhalation, f‚ÇÅ values for ingestion) dramatically affects dose coefficient values.
                                </p>
                            </div>
                            <div class="bg-green-50 p-4 rounded border border-green-200">
                                <h4 class="font-semibold text-green-700">Particle Size</h4>
                                <p class="text-sm text-green-600 mt-2">
                                    AMAD affects initial deposition pattern in respiratory tract and subsequent clearance pathways.
                                </p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded border border-purple-200">
                                <h4 class="font-semibold text-purple-700">Age/Gender</h4>
                                <p class="text-sm text-purple-600 mt-2">
                                    Different dose coefficients available for adults, children, and sometimes gender-specific values.
                                </p>
                            </div>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">Worked Example: Plutonium-239 Inhalation</h3>
                        <div class="bg-blue-50 p-4 rounded border">
                            <div class="space-y-2 text-sm">
                                <div><strong>Scenario:</strong> Worker inhaled estimated 100 Bq Pu-239 oxide particles</div>
                                <div><strong>Chemical Form:</strong> Plutonium oxide (Type S, AMAD 1 Œºm)</div>
                                <div><strong>Dose Coefficient:</strong> e‚ÇÖ‚ÇÄ = 1.2 √ó 10‚Åª‚Å¥ Sv/Bq (ICRP 68)</div>
                                <div><strong>Calculation:</strong> CED = 100 Bq √ó 1.2 √ó 10‚Åª‚Å¥ Sv/Bq = 0.012 Sv = 12 mSv</div>
                                <div class="mt-3 p-2 bg-amber-100 rounded">
                                    <strong>Regulatory Context:</strong> This exceeds the annual limit (20 mSv) and requires immediate investigation and potential work restrictions.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="section-2-complete-btn" onclick="markSectionComplete('section-2')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                            Mark Section Complete
                        </button>
                        <button id="section-2-reset-btn" onclick="unmarkSection('section-2')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                            Reset Section
                        </button>
                    </div>
                </section>

                <!-- Section 3: Regulatory Compliance -->
                <section id="section-3" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">3. Regulatory Compliance and Dose Limits</h2>
                        <div class="flex items-center space-x-2">
                            <div id="section-3-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                                <span class="text-xs font-bold text-stone-400">3</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prose max-w-none">
                        <p class="text-stone-700 mb-4">
                            Converting dose calculations into actionable health physics decisions requires understanding regulatory 
                            limits, ALARA principles, and practical implementation considerations.
                        </p>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">U.S. Regulatory Framework (10 CFR 20)</h3>
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-red-50 p-4 rounded border border-red-200">
                                <h4 class="font-semibold text-red-700">Annual Dose Limits</h4>
                                <ul class="text-sm text-red-600 mt-2 space-y-1">
                                    <li>‚Ä¢ <strong>TEDE:</strong> 50 mSv (5 rem) per year</li>
                                    <li>‚Ä¢ <strong>Lens of eye:</strong> 150 mSv (15 rem)</li>
                                    <li>‚Ä¢ <strong>Skin/extremities:</strong> 500 mSv (50 rem)</li>
                                    <li>‚Ä¢ <strong>Public:</strong> 1 mSv (0.1 rem)</li>
                                </ul>
                            </div>
                            <div class="bg-orange-50 p-4 rounded border border-orange-200">
                                <h4 class="font-semibold text-orange-700">Action Levels</h4>
                                <ul class="text-sm text-orange-600 mt-2 space-y-1">
                                    <li>‚Ä¢ <strong>Investigation:</strong> 10% of limit</li>
                                    <li>‚Ä¢ <strong>Medical evaluation:</strong> Case-specific</li>
                                    <li>‚Ä¢ <strong>Work restrictions:</strong> Approaching limits</li>
                                    <li>‚Ä¢ <strong>Bioassay frequency:</strong> Risk-based</li>
                                </ul>
                            </div>
                        </div>

                        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 my-6">
                            <div class="flex">
                                <div class="flex-shrink-0">‚ö†Ô∏è</div>
                                <div class="ml-3">
                                    <p class="text-amber-800">
                                        <strong>Critical Point:</strong> Internal dose is often the dominant contributor to total dose. 
                                        A single significant intake can exceed annual limits, making prevention and early detection essential.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">ALARA Implementation</h3>
                        <div class="bg-green-50 p-4 rounded border">
                            <h4 class="font-semibold text-green-700 mb-2">Administrative Dose Constraints</h4>
                            <p class="text-sm text-green-600 mb-2">Many facilities set internal dose constraints well below regulatory limits:</p>
                            <ul class="text-sm text-green-600 space-y-1">
                                <li>‚Ä¢ Typical constraint: 2-5 mSv/year internal dose</li>
                                <li>‚Ä¢ Investigation levels: 10% of regulatory limit</li>
                                <li>‚Ä¢ ALARA goal: Reduce collective dose year-over-year</li>
                                <li>‚Ä¢ Cost-benefit analysis for dose reduction measures</li>
                            </ul>
                        </div>

                        <div class="border border-stone-200 rounded-lg mb-4">
                            <button class="collapse-btn w-full text-left p-4 hover:bg-stone-50" onclick="toggleCollapse('deep-dive-decisions')">
                                <span class="font-semibold">üî¨ Deep Dive: Decision-Making Framework</span>
                                <span class="float-right">‚ñº</span>
                            </button>
                            <div id="deep-dive-decisions" class="collapse-content hidden p-4 border-t border-stone-200">
                                <h4 class="font-semibold mb-3">Step-by-Step Decision Process:</h4>
                                <div class="space-y-3 text-sm">
                                    <div class="bg-blue-50 p-3 rounded">
                                        <strong>Step 1: Calculate CED</strong><br>
                                        Use best estimate intake and appropriate dose coefficients
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded">
                                        <strong>Step 2: Assess Uncertainty</strong><br>
                                        Consider uncertainties in intake estimation and dose coefficients
                                    </div>
                                    <div class="bg-orange-50 p-3 rounded">
                                        <strong>Step 3: Compare to Limits</strong><br>
                                        Evaluate against regulatory limits and administrative constraints
                                    </div>
                                    <div class="bg-red-50 p-3 rounded">
                                        <strong>Step 4: Determine Actions</strong><br>
                                        Medical evaluation, work restrictions, bioassay frequency adjustments
                                    </div>
                                    <div class="bg-green-50 p-3 rounded">
                                        <strong>Step 5: Document Decision</strong><br>
                                        Record rationale, assumptions, and follow-up requirements
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="section-3-complete-btn" onclick="markSectionComplete('section-3')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                            Mark Section Complete
                        </button>
                        <button id="section-3-reset-btn" onclick="unmarkSection('section-3')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                            Reset Section
                        </button>
                    </div>
                </section>

                <!-- Section 4: Uncertainty and Advanced Applications -->
                <section id="section-4" class="progress-section mb-8 p-6 border-l-4 border-stone-300 bg-stone-50 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">4. Uncertainty Analysis and Advanced Applications</h2>
                        <div class="flex items-center space-x-2">
                            <div id="section-4-status" class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center">
                                <span class="text-xs font-bold text-stone-400">4</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prose max-w-none">
                        <p class="text-stone-700 mb-4">
                            Real-world dose calculations involve significant uncertainties. Understanding and quantifying these 
                            uncertainties is crucial for making informed health physics decisions.
                        </p>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">Sources of Uncertainty</h3>
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div class="space-y-3">
                                <div class="bg-purple-50 p-3 rounded border">
                                    <h4 class="font-semibold text-purple-700">Measurement Uncertainty</h4>
                                    <ul class="text-sm text-purple-600 mt-1 space-y-1">
                                        <li>‚Ä¢ Bioassay measurement precision</li>
                                        <li>‚Ä¢ Detection limits and MDA</li>
                                        <li>‚Ä¢ Sampling representativeness</li>
                                        <li>‚Ä¢ Laboratory calibration errors</li>
                                    </ul>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded border">
                                    <h4 class="font-semibold text-indigo-700">Model Uncertainty</h4>
                                    <ul class="text-sm text-indigo-600 mt-1 space-y-1">
                                        <li>‚Ä¢ Biokinetic model limitations</li>
                                        <li>‚Ä¢ Individual variability</li>
                                        <li>‚Ä¢ Chemical form assumptions</li>
                                        <li>‚Ä¢ Particle size effects</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="bg-teal-50 p-3 rounded border">
                                    <h4 class="font-semibold text-teal-700">Exposure Scenario</h4>
                                    <ul class="text-sm text-teal-600 mt-1 space-y-1">
                                        <li>‚Ä¢ Intake timing uncertainty</li>
                                        <li>‚Ä¢ Exposure pathway assumptions</li>
                                        <li>‚Ä¢ Multiple exposure events</li>
                                        <li>‚Ä¢ Chronic vs. acute scenarios</li>
                                    </ul>
                                </div>
                                <div class="bg-cyan-50 p-3 rounded border">
                                    <h4 class="font-semibold text-cyan-700">Dosimetric Factors</h4>
                                    <ul class="text-sm text-cyan-600 mt-1 space-y-1">
                                        <li>‚Ä¢ Dose coefficient uncertainties</li>
                                        <li>‚Ä¢ Tissue weighting factors</li>
                                        <li>‚Ä¢ Radiation quality factors</li>
                                        <li>‚Ä¢ Age and gender dependencies</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">Uncertainty Quantification Methods</h3>
                        <div class="bg-stone-100 p-4 rounded border-l-4 border-blue-500 my-4">
                            <h4 class="font-semibold mb-2">Monte Carlo Approach</h4>
                            <p class="text-sm mb-2">Probabilistic method using parameter distributions:</p>
                            <div class="font-mono text-xs bg-white p-2 rounded">
                                For i = 1 to N simulations:<br>
                                &nbsp;&nbsp;Sample intake_i from uncertainty distribution<br>
                                &nbsp;&nbsp;Sample dose_coeff_i from uncertainty distribution<br>
                                &nbsp;&nbsp;Calculate dose_i = intake_i √ó dose_coeff_i<br>
                                Result: Distribution of possible doses
                            </div>
                        </div>

                        <h3 class="text-lg font-semibold mt-6 mb-3 text-stone-800">Software Tools and Implementation</h3>
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded border">
                                <h4 class="font-semibold text-blue-700">IMBA Professional</h4>
                                <p class="text-sm text-blue-600 mt-2">
                                    Industry standard for internal dose calculations with built-in uncertainty analysis and regulatory compliance features.
                                </p>
                            </div>
                            <div class="bg-green-50 p-4 rounded border">
                                <h4 class="font-semibold text-green-700">AIDE (ICRP)</h4>
                                <p class="text-sm text-green-600 mt-2">
                                    Free software implementing ICRP biokinetic models with uncertainty quantification capabilities.
                                </p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded border">
                                <h4 class="font-semibold text-purple-700">Custom Tools</h4>
                                <p class="text-sm text-purple-600 mt-2">
                                    Specialized calculators for specific scenarios, often developed for particular facility needs.
                                </p>
                            </div>
                        </div>

                        <div class="border border-stone-200 rounded-lg mb-4">
                            <button class="collapse-btn w-full text-left p-4 hover:bg-stone-50" onclick="toggleCollapse('deep-dive-sensitivity')">
                                <span class="font-semibold">üî¨ Deep Dive: Sensitivity Analysis Example</span>
                                <span class="float-right">‚ñº</span>
                            </button>
                            <div id="deep-dive-sensitivity" class="collapse-content hidden p-4 border-t border-stone-200">
                                <h4 class="font-semibold mb-3">Plutonium-239 Inhalation Sensitivity Study</h4>
                                <div class="bg-gray-50 p-4 rounded text-sm">
                                    <p class="mb-3"><strong>Base Case:</strong> 100 Bq intake, Type S, AMAD 1 Œºm ‚Üí 12 mSv CED</p>
                                    
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-semibold">Parameter Variations:</h5>
                                            <ul class="space-y-1 text-xs">
                                                <li>‚Ä¢ <strong>Intake ¬±50%:</strong> 6-18 mSv (linear effect)</li>
                                                <li>‚Ä¢ <strong>AMAD 0.3-10 Œºm:</strong> 8-15 mSv (modest effect)</li>
                                                <li>‚Ä¢ <strong>Type M vs S:</strong> 1.2 vs 12 mSv (10√ó difference!)</li>
                                                <li>‚Ä¢ <strong>Individual variability:</strong> ¬±factor of 2-3</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h5 class="font-semibold">Key Insights:</h5>
                                            <ul class="space-y-1 text-xs">
                                                <li>‚Ä¢ Chemical form dominates uncertainty</li>
                                                <li>‚Ä¢ Particle size has moderate impact</li>
                                                <li>‚Ä¢ Individual differences are significant</li>
                                                <li>‚Ä¢ Conservative assumptions often justified</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button id="section-4-complete-btn" onclick="markSectionComplete('section-4')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                            Mark Section Complete
                        </button>
                        <button id="section-4-reset-btn" onclick="unmarkSection('section-4')" class="hidden ml-2 text-stone-500 hover:text-red-600 text-sm px-3 py-1 border border-stone-300 rounded hover:border-red-300 transition-colors">
                            Reset Section
                        </button>
                    </div>
                </section>

                <!-- Knowledge Check Quiz -->
                <section id="knowledge-check" class="mb-8 p-6 bg-gradient-to-r from-purple-50 to-violet-50 rounded-lg border border-purple-200">
                    <h2 class="text-2xl font-bold mb-4 text-purple-800">üß† Knowledge Check</h2>
                    <p class="text-purple-700 mb-6">Test your understanding of dose calculation concepts - this is the capstone assessment!</p>
                    
                    <div id="quiz-container">
                        <!-- Quiz Question 1 -->
                        <div id="question-1" class="quiz-question active">
                            <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 1 of 4</h3>
                            <p class="text-stone-700 mb-4">A worker inhaled 50 Bq of Co-60 as oxide particles (Type M, AMAD 1 Œºm). The dose coefficient for inhalation is 3.1 √ó 10‚Åª‚Åµ Sv/Bq. What is the committed effective dose, and what immediate actions are required?</p>
                            <div class="space-y-2">
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="A">
                                    <span class="font-semibold">A)</span> Cannot determine without knowing the intake timing
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="B">
                                    <span class="font-semibold">B)</span> 1.6 mSv - investigate and document, implement additional bioassay
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="C">
                                    <span class="font-semibold">C)</span> 0.0016 mSv - no action required, below investigation level
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="1" data-option="D">
                                    <span class="font-semibold">D)</span> 16 mSv - work restrictions required, medical evaluation needed
                                </div>
                            </div>
                            <div id="explanation-1" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                                <p class="text-green-800 text-sm"><strong>Correct!</strong> CED = 50 Bq √ó 3.1 √ó 10‚Åª‚Åµ Sv/Bq = 1.6 mSv. This exceeds typical investigation levels (0.5-1 mSv) and requires documentation, investigation of the exposure circumstances, and likely increased bioassay frequency to verify no additional intake occurred.</p>
                            </div>
                        </div>

                        <!-- Quiz Question 2 -->
                        <div id="question-2" class="quiz-question">
                            <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 2 of 4</h3>
                            <p class="text-stone-700 mb-4">Two workers have identical bioassay results 30 days post-exposure, but different assumed chemical forms: Worker A (Type F), Worker B (Type S). How will their calculated doses compare?</p>
                            <div class="space-y-2">
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="A">
                                    <span class="font-semibold">A)</span> Worker A (Type F) will have higher calculated dose due to faster clearance
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="B">
                                    <span class="font-semibold">B)</span> Identical doses - bioassay results are the same
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="C">
                                    <span class="font-semibold">C)</span> Worker B (Type S) will have higher calculated dose due to longer retention
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="2" data-option="D">
                                    <span class="font-semibold">D)</span> Cannot determine without knowing the specific radionuclide
                                </div>
                            </div>
                            <div id="explanation-2" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                                <p class="text-green-800 text-sm"><strong>Correct!</strong> If both workers show the same bioassay result at 30 days, Worker A (Type F) must have had a larger initial intake since Type F material clears faster. The larger intake leads to higher calculated dose despite faster clearance. This illustrates why chemical form determination is critical for accurate dose assessment.</p>
                            </div>
                        </div>

                        <!-- Quiz Question 3 -->
                        <div id="question-3" class="quiz-question">
                            <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 3 of 4</h3>
                            <p class="text-stone-700 mb-4">A facility sets an administrative dose constraint of 2 mSv/year internal dose (10% of regulatory limit). What is the primary purpose of this constraint in ALARA implementation?</p>
                            <div class="space-y-2">
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="A">
                                    <span class="font-semibold">A)</span> To trigger preventive actions before doses approach regulatory limits
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="B">
                                    <span class="font-semibold">B)</span> To satisfy regulatory requirements for dose limits
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="C">
                                    <span class="font-semibold">C)</span> To reduce the facility's liability in case of regulatory inspection
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="3" data-option="D">
                                    <span class="font-semibold">D)</span> To account for uncertainty in dose calculations
                                </div>
                            </div>
                            <div id="explanation-3" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                                <p class="text-green-800 text-sm"><strong>Correct!</strong> Administrative constraints are ALARA tools designed to trigger investigation and corrective action before doses approach regulatory limits. This allows time to identify and correct problems, implement additional controls, or restrict work activities while maintaining regulatory compliance margins.</p>
                            </div>
                        </div>

                        <!-- Quiz Question 4 -->
                        <div id="question-4" class="quiz-question">
                            <h3 class="text-lg font-semibold mb-4 text-stone-800">Question 4 of 4</h3>
                            <p class="text-stone-700 mb-4">In a Monte Carlo uncertainty analysis of internal dose, which factor typically contributes the MOST uncertainty to the final dose estimate?</p>
                            <div class="space-y-2">
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="A">
                                    <span class="font-semibold">A)</span> Chemical form and particle size assumptions
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="B">
                                    <span class="font-semibold">B)</span> Bioassay measurement precision (counting statistics)
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="C">
                                    <span class="font-semibold">C)</span> Individual biological variability in clearance rates
                                </div>
                                <div class="quiz-option p-3 border border-stone-300 rounded cursor-pointer" data-question="4" data-option="D">
                                    <span class="font-semibold">D)</span> Uncertainty in dose coefficients from ICRP models
                                </div>
                            </div>
                            <div id="explanation-4" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded">
                                <p class="text-green-800 text-sm"><strong>Correct!</strong> Chemical form assumptions typically dominate uncertainty because they can change dose estimates by factors of 10 or more (e.g., Type F vs. Type S). While other factors contribute, the biokinetic behavior differences between chemical forms usually represent the largest source of uncertainty in internal dose assessments.</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-6">
                        <div class="flex space-x-2">
                            <button id="prev-question" class="px-4 py-2 bg-stone-500 text-white rounded hover:bg-stone-600 transition-colors disabled:opacity-50" disabled>
                                Previous
                            </button>
                            <button onclick="resetQuiz()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                                Reset Quiz
                            </button>
                        </div>
                        <div class="flex space-x-2">
                            <span id="question-indicator" class="px-3 py-1 bg-purple-100 text-purple-800 rounded text-sm">Question 1 of 4</span>
                        </div>
                        <button id="next-question" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                            Next Question
                        </button>
                    </div>
                </section>
    </main>

    <script>
        // Progress tracking system
        let sectionProgress = {
            'section-1': false,
            'section-2': false,
            'section-3': false,
            'section-4': false
        };

        // Load progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem('dose-calculation-progress');
            if (saved) {
                sectionProgress = { ...sectionProgress, ...JSON.parse(saved) };
                updateProgressDisplay();
                updateSectionVisuals();
                updateSidebarProgress();
            }
        }

        // Save progress to localStorage
        function saveProgress() {
            localStorage.setItem('dose-calculation-progress', JSON.stringify(sectionProgress));
        }

        // Mark section complete
        function markSectionComplete(sectionId) {
            sectionProgress[sectionId] = true;
            saveProgress();
            updateProgressDisplay();
            updateSectionVisuals();
            updateSidebarProgress();
            
            // Visual feedback
            const section = document.getElementById(sectionId);
            section.classList.add('completed');
            
            // Animate status indicator
            const status = document.getElementById(sectionId + '-status');
            status.innerHTML = '<svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
            status.style.backgroundColor = '#7c3aed';
            status.style.borderColor = '#7c3aed';
            
            // Update button states
            const completeBtn = document.getElementById(sectionId + '-complete-btn');
            const resetBtn = document.getElementById(sectionId + '-reset-btn');
            
            if (completeBtn) {
                completeBtn.classList.add('bg-stone-400', 'cursor-not-allowed');
                completeBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                completeBtn.disabled = true;
                completeBtn.innerHTML = '‚úì Section Complete';
            }
            
            if (resetBtn) {
                resetBtn.classList.remove('hidden');
            }
        }

        // Unmark section (reset)
        function unmarkSection(sectionId) {
            sectionProgress[sectionId] = false;
            saveProgress();
            updateProgressDisplay();
            updateSectionVisuals();
            updateSidebarProgress();
            
            // Reset visual state
            const section = document.getElementById(sectionId);
            section.classList.remove('completed');
            
            // Reset status indicator
            const status = document.getElementById(sectionId + '-status');
            const sectionNumber = sectionId.split('-')[1];
            status.innerHTML = `<span class="text-xs font-bold text-stone-400">${sectionNumber}</span>`;
            status.style.backgroundColor = '';
            status.style.borderColor = '#d1d5db';
            
            // Reset button states
            const completeBtn = document.getElementById(sectionId + '-complete-btn');
            const resetBtn = document.getElementById(sectionId + '-reset-btn');
            
            if (completeBtn) {
                completeBtn.classList.remove('bg-stone-400', 'cursor-not-allowed');
                completeBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                completeBtn.disabled = false;
                completeBtn.innerHTML = 'Mark Section Complete';
            }
            
            if (resetBtn) {
                resetBtn.classList.add('hidden');
            }
        }

        // Reset all progress
        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress for this module? This cannot be undone.')) {
                // Reset progress object
                Object.keys(sectionProgress).forEach(key => {
                    sectionProgress[key] = false;
                });
                
                // Reset quiz state if needed
                
                // Save and update display
                saveProgress();
                updateProgressDisplay();
                updateSectionVisuals();
                updateSidebarProgress();
                
                alert('Progress has been reset successfully!');
            }
        }

        // Reset all progress (alternative function for sidebar)
        function resetAllProgress() {
            resetProgress();
        }

        // Toggle sidebar visibility
        function toggleSidebar() {
            const content = document.getElementById('sidebar-content');
            const toggle = document.getElementById('sidebar-toggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        // Update sidebar progress display
        function updateSidebarProgress() {
            const completed = Object.values(sectionProgress).filter(Boolean).length;
            const total = Object.keys(sectionProgress).length;
            
            // Update overall progress bar width (not text)
            const sidebarProgress = document.getElementById('overall-progress');
            if (sidebarProgress) {
                const percentage = Math.round((completed / total) * 100);
                sidebarProgress.style.width = percentage + '%';
            }
            
            // Update section checklist
            const checklist = document.getElementById('section-checklist');
            if (checklist) {
                checklist.innerHTML = `
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm text-stone-600">1. Dose Coefficients</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-1'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-1'] ? '‚úì' : '‚óã'}</span>
                            ${sectionProgress['section-1'] ? '<button onclick="unmarkSection(\'section-1\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm text-stone-600">2. Dose Calculation</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-2'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-2'] ? '‚úì' : '‚óã'}</span>
                            ${sectionProgress['section-2'] ? '<button onclick="unmarkSection(\'section-2\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm text-stone-600">3. Regulatory Compliance</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-3'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-3'] ? '‚úì' : '‚óã'}</span>
                            ${sectionProgress['section-3'] ? '<button onclick="unmarkSection(\'section-3\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between py-1">
                        <span class="text-sm text-stone-600">4. Uncertainty Analysis</span>
                        <div class="flex items-center space-x-2">
                            <span class="${sectionProgress['section-4'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-4'] ? '‚úì' : '‚óã'}</span>
                            ${sectionProgress['section-4'] ? '<button onclick="unmarkSection(\'section-4\')" class="text-xs text-red-500 hover:text-red-700">Reset</button>' : ''}
                        </div>
                    </div>
                `;
            }
        }

        // Update progress display
        function updateProgressDisplay() {
            const completed = Object.values(sectionProgress).filter(Boolean).length;
            const total = Object.keys(sectionProgress).length;
            const percentage = Math.round((completed / total) * 100);
            
            // Update progress bar  
            document.getElementById('overall-progress').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = percentage + '% Complete';
            
            // CRITICAL: Always update sidebar
            updateSidebarProgress();
        }

        // Show progress detail modal
        function showProgressDetail() {
            const modal = document.getElementById('progressModal');
            if (modal) {
                modal.classList.remove('hidden');
                updateProgressDetails();
            }
        }

        // Close progress modal
        function closeProgressModal() {
            const modal = document.getElementById('progressModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Update progress details in modal
        function updateProgressDetails() {
            const completed = Object.values(sectionProgress).filter(Boolean).length;
            const total = Object.keys(sectionProgress).length;
            const percentage = Math.round((completed / total) * 100);
            
            const details = document.getElementById('progressDetails');
            if (details) {
                details.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-2 rounded ${sectionProgress['section-1'] ? 'bg-green-50' : 'bg-stone-50'}">
                            <span class="text-sm">1. Dose Coefficients</span>
                            <span class="${sectionProgress['section-1'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-1'] ? '‚úì Complete' : 'Pending'}</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded ${sectionProgress['section-2'] ? 'bg-green-50' : 'bg-stone-50'}">
                            <span class="text-sm">2. Dose Calculation</span>
                            <span class="${sectionProgress['section-2'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-2'] ? '‚úì Complete' : 'Pending'}</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded ${sectionProgress['section-3'] ? 'bg-green-50' : 'bg-stone-50'}">
                            <span class="text-sm">3. Regulatory Compliance</span>
                            <span class="${sectionProgress['section-3'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-3'] ? '‚úì Complete' : 'Pending'}</span>
                        </div>
                        <div class="flex justify-between items-center p-2 rounded ${sectionProgress['section-4'] ? 'bg-green-50' : 'bg-stone-50'}">
                            <span class="text-sm">4. Uncertainty Analysis</span>
                            <span class="${sectionProgress['section-4'] ? 'text-green-600' : 'text-stone-400'}">${sectionProgress['section-4'] ? '‚úì Complete' : 'Pending'}</span>
                        </div>
                        <div class="mt-4 pt-3 border-t border-stone-200">
                            <div class="text-center">
                                <span class="text-lg font-semibold text-stone-700">${percentage}% Complete</span>
                                <p class="text-sm text-stone-500">${completed} of ${total} sections completed</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Update section visuals
        function updateSectionVisuals() {
            // Update section status indicators
            Object.keys(sectionProgress).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const status = document.getElementById(sectionId + '-status');
                const completeBtn = document.getElementById(sectionId + '-complete-btn');
                const resetBtn = document.getElementById(sectionId + '-reset-btn');
                
                if (sectionProgress[sectionId]) {
                    if (section) section.classList.add('completed');
                    if (status) {
                        status.innerHTML = '<svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                        status.style.backgroundColor = '#7c3aed';
                        status.style.borderColor = '#7c3aed';
                    }
                    if (completeBtn) {
                        completeBtn.classList.add('bg-stone-400', 'cursor-not-allowed');
                        completeBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        completeBtn.disabled = true;
                        completeBtn.innerHTML = '‚úì Section Complete';
                    }
                    if (resetBtn) {
                        resetBtn.classList.remove('hidden');
                    }
                } else {
                    if (section) section.classList.remove('completed');
                    if (status) {
                        const sectionNumber = sectionId.split('-')[1];
                        status.innerHTML = `<span class="text-xs font-bold text-stone-400">${sectionNumber}</span>`;
                        status.style.backgroundColor = '';
                        status.style.borderColor = '#d1d5db';
                    }
                    if (completeBtn) {
                        completeBtn.classList.remove('bg-stone-400', 'cursor-not-allowed');
                        completeBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        completeBtn.disabled = false;
                        completeBtn.innerHTML = 'Mark Section Complete';
                    }
                    if (resetBtn) {
                        resetBtn.classList.add('hidden');
                    }
                }
            });
        }

        // Toggle collapsible content
        function toggleCollapse(id) {
            const content = document.getElementById(id);
            const button = event.target.closest('.collapse-btn');
            const arrow = button.querySelector('span:last-child');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '‚ñ≤';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '‚ñº';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProgress();
            updateSidebarProgress(); // CRITICAL: Initialize sidebar
            initializeQuiz();
            initializeGlossarySystem(); // Initialize glossary modal system
        });

        // Quiz system with persistence
        let quizState = {
            currentQuestion: 1,
            totalQuestions: 4,
            answers: {},
            correctAnswers: { 1: 'B', 2: 'A', 3: 'A', 4: 'A' }
        };

        function initializeQuiz() {
            loadQuizState();
            setupQuizEventListeners();
            updateQuizDisplay();
            restoreQuizState();
        }

        function loadQuizState() {
            const saved = localStorage.getItem('dose-calculation-quiz');
            if (saved) {
                const savedState = JSON.parse(saved);
                quizState = { ...quizState, ...savedState };
            }
        }

        function saveQuizState() {
            localStorage.setItem('dose-calculation-quiz', JSON.stringify(quizState));
        }

        function setupQuizEventListeners() {
            // Add click handlers to quiz options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    const question = parseInt(this.getAttribute('data-question'));
                    const selectedOption = this.getAttribute('data-option');
                    selectQuizOption(question, selectedOption);
                });
            });

            // Add handlers to navigation buttons
            const prevBtn = document.getElementById('prev-question');
            const nextBtn = document.getElementById('next-question');
            
            if (prevBtn) prevBtn.addEventListener('click', previousQuestion);
            if (nextBtn) nextBtn.addEventListener('click', nextQuestion);
        }

        function selectQuizOption(questionNum, option) {
            // Store the answer
            quizState.answers[questionNum] = option;
            saveQuizState();
            
            // Remove previous selections for this question
            document.querySelectorAll(`[data-question="${questionNum}"]`).forEach(opt => {
                opt.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
                opt.classList.add('border-stone-300');
            });
            
            // Highlight selected option
            const selectedElement = document.querySelector(`[data-question="${questionNum}"][data-option="${option}"]`);
            const isCorrect = option === quizState.correctAnswers[questionNum];
            
            if (isCorrect) {
                selectedElement.classList.remove('border-stone-300');
                selectedElement.classList.add('border-green-500', 'bg-green-50');
            } else {
                selectedElement.classList.remove('border-stone-300');
                selectedElement.classList.add('border-red-500', 'bg-red-50');
            }
            
            // Show explanation
            showQuizExplanation(questionNum, isCorrect);
        }

        function showQuizExplanation(questionNum, isCorrect) {
            const explanation = document.getElementById(`explanation-${questionNum}`);
            if (!explanation) return;
            
            explanation.classList.remove('hidden');
            
            if (isCorrect) {
                explanation.classList.remove('bg-red-50', 'border-red-200');
                explanation.classList.add('bg-green-50', 'border-green-200');
                const p = explanation.querySelector('p');
                if (p) p.className = 'text-green-800 text-sm';
            } else {
                explanation.classList.remove('bg-green-50', 'border-green-200');
                explanation.classList.add('bg-red-50', 'border-red-200');
                
                const correctAnswer = quizState.correctAnswers[questionNum];
                explanation.innerHTML = `
                    <p class="text-red-800 text-sm">
                        <strong>Incorrect.</strong> The correct answer is <strong>${correctAnswer}</strong>. 
                        ${getCorrectExplanation(questionNum)}
                    </p>
                `;
            }
        }

        function getCorrectExplanation(questionNum) {
            const explanations = {
                1: "CED = 50 Bq √ó 3.1 √ó 10‚Åª‚Åµ Sv/Bq = 1.6 mSv. This exceeds typical investigation levels and requires documentation and follow-up.",
                2: "If both workers show the same bioassay result at 30 days, Worker A (Type F) must have had a larger initial intake since Type F material clears faster, leading to higher calculated dose.",
                3: "Administrative constraints are ALARA tools designed to trigger investigation and corrective action before doses approach regulatory limits.",
                4: "Chemical form assumptions typically dominate uncertainty because they can change dose estimates by factors of 10 or more (e.g., Type F vs. Type S)."
            };
            return explanations[questionNum] || "Review the material for the correct answer.";
        }

        function restoreQuizState() {
            // Restore selected answers
            Object.keys(quizState.answers).forEach(questionNum => {
                const option = quizState.answers[questionNum];
                if (option) {
                    selectQuizOption(parseInt(questionNum), option);
                }
            });
        }

        function nextQuestion() {
            if (quizState.currentQuestion < quizState.totalQuestions) {
                quizState.currentQuestion++;
                saveQuizState();
                updateQuizDisplay();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (quizState.currentQuestion > 1) {
                quizState.currentQuestion--;
                saveQuizState();
                updateQuizDisplay();
            }
        }

        function updateQuizDisplay() {
            // Hide all explanations when changing questions
            document.querySelectorAll('[id^="explanation-"]').forEach(exp => {
                exp.classList.add('hidden');
            });
            
            // Update question indicator
            const indicator = document.getElementById('question-indicator');
            if (indicator) {
                indicator.textContent = `Question ${quizState.currentQuestion} of ${quizState.totalQuestions}`;
            }
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prev-question');
            const nextBtn = document.getElementById('next-question');
            
            if (prevBtn) {
                prevBtn.disabled = quizState.currentQuestion === 1;
            }
            
            if (nextBtn) {
                if (quizState.currentQuestion === quizState.totalQuestions) {
                    nextBtn.textContent = 'Finish Quiz';
                } else {
                    nextBtn.textContent = 'Next Question';
                }
            }
            
            // Show/hide questions
            for (let i = 1; i <= quizState.totalQuestions; i++) {
                const questionElement = document.getElementById(`question-${i}`);
                if (questionElement) {
                    if (i === quizState.currentQuestion) {
                        questionElement.style.display = 'block';
                        questionElement.classList.add('active');
                    } else {
                        questionElement.style.display = 'none';
                        questionElement.classList.remove('active');
                    }
                }
            }
        }

        function resetQuiz() {
            if (confirm('Are you sure you want to reset the quiz? This will clear all your answers.')) {
                quizState.answers = {};
                quizState.currentQuestion = 1;
                saveQuizState();
                
                // Reset all visual states
                document.querySelectorAll('.quiz-option').forEach(option => {
                    option.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
                    option.classList.add('border-stone-300');
                });
                
                // Hide all explanations
                document.querySelectorAll('[id^="explanation-"]').forEach(exp => {
                    exp.classList.add('hidden');
                });
                
                updateQuizDisplay();
                alert('Quiz has been reset successfully!');
            }
        }

        function finishQuiz() {
            const totalAnswered = Object.keys(quizState.answers).length;
            const correctCount = Object.keys(quizState.answers).filter(q => 
                quizState.answers[q] === quizState.correctAnswers[parseInt(q)]
            ).length;
            
            const score = totalAnswered > 0 ? Math.round((correctCount / quizState.totalQuestions) * 100) : 0;
            
            let message = `Quiz Complete!\n\nScore: ${correctCount}/${quizState.totalQuestions} (${score}%)\nAnswered: ${totalAnswered}/${quizState.totalQuestions} questions`;
            
            if (score >= 75) {
                message += "\n\nüéâ Excellent work! You've demonstrated strong understanding of dose calculation concepts.";
            } else if (score >= 50) {
                message += "\n\nüëç Good effort! Review the explanations and consider retaking the quiz to improve your score.";
            } else {
                message += "\n\nüìö Keep studying! Review the module content and explanations, then try again.";
            }
            
            alert(message);
        }
    </script>
</body>
</html>

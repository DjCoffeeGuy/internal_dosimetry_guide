<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Guide to Internal Dosimetry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutral (Stone, Amber) -->
    <!-- Application Structure Plan: A single-page application with a top navigation bar (Overview, Key Concepts, Biokinetic Models, Dose Calculation) to switch between content sections. This non-linear, tabbed structure was chosen to allow users to freely explore topics of interest, which is more intuitive for a learning tool than a linear document. Interactions include clickable cards for definitions, animated diagrams for model concepts, and an interactive breakdown of the dose formula. -->
    <!-- Visualization & Content Choices: Key Concepts -> Goal: Inform -> Interactive Cards (HTML/JS) -> User clicks to reveal definitions, promoting active learning. Biokinetic Models -> Goal: Organize/Change -> Animated Diagrams (HTML/JS) & Static Diagrams (HTML/CSS) -> Visually demonstrates the complex flow of radionuclides, making abstract models tangible. New sections for ICRP 60 (68) and OIR models provide textual summaries of their advancements. Dose Calculation -> Goal: Compare/Inform -> Interactive Bar Chart (Chart.js) & Clickable Formula -> Allows users to see the relative contribution of different source organs to a target organ's dose and deconstruct the main formula, clarifying a complex calculation. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }
        .nav-link {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            border-bottom-color: #d97706; /* amber-600 */
            color: #d97706; /* amber-600 */
        }
        .concept-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .concept-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .interactive-formula span {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            color: #d97706; /* amber-600 */
        }
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #d97706; /* amber-600 */
            border-radius: 50%;
            transition: all 1s linear; /* Smooth transition for movement */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #d97706;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* New CSS for model-content sections */
        .model-content {
            display: none;
        }
        .model-content.active {
            display: block;
        }
    </style>
</head>
<body class="text-stone-800">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-2xl font-bold text-stone-900">Interactive Guide to Internal Dosimetry</h1>
                <nav class="hidden md:flex space-x-8">
                    <a href="#" id="nav-overview" class="nav-link text-lg font-medium text-stone-600 hover:text-amber-600 active">Overview</a>
                    <a href="#" id="nav-concepts" class="nav-link text-lg font-medium text-stone-600 hover:text-amber-600">Key Concepts</a>
                    <a href="#" id="nav-models" class="nav-link text-lg font-medium text-stone-600 hover:text-amber-600">Biokinetic Models</a>
                    <a href="#" id="nav-calculation" class="nav-link text-lg font-medium text-stone-600 hover:text-amber-600">Dose Calculation</a>
                </nav>
                 <div class="md:hidden">
                    <select id="mobile-nav" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                        <option value="overview">Overview</option>
                        <option value="concepts">Key Concepts</option>
                        <option value="models">Biokinetic Models</option>
                        <option value="calculation">Dose Calculation</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section id="overview" class="content-section active">
            <div class="bg-white p-8 rounded-lg shadow">
                <h2 class="text-3xl font-bold mb-4 text-amber-700">Welcome to Your Simplified Guide!</h2>
                <p class="text-lg mb-4">This application demystifies the core principles of occupational internal dosimetry, focusing on the ICRP Publication 30 framework. It's designed to help you understand *what* things are and *why* they matter, without getting bogged down in complex mathematical derivations.</p>
                <div class="prose max-w-none">
                    <h3 class="text-2xl font-semibold mt-6 mb-2">What is Internal Dosimetry?</h3>
                    <p>At its heart, internal dosimetry is about assessing the radiation dose a person receives from radioactive material that has entered their body. Unlike external radiation from outside sources, internal radiation comes from radionuclides *inside* the body.</p>
                    <h4 class="text-xl font-semibold mt-4 mb-2">Why is dose "inferred" and not "measured"?</h4>
                    <p>You can't directly measure the dose to an internal organ in a living person. Instead, we infer (or estimate) the dose by:</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li><strong>Measuring</strong> the amount of radioactive material in the body or in excreta. This is called <strong>radiobioassay</strong>.</li>
                        <li><strong>Using mathematical models</strong> that describe how these materials behave in the human body.</li>
                        <li><strong>Applying dose coefficients</strong> that convert the amount of radioactivity and its behavior into a radiation dose.</li>
                    </ol>
                    <h4 class="text-xl font-semibold mt-4 mb-2">Why is it important?</h4>
                     <ul class="list-disc list-inside space-y-2">
                        <li><strong>It's required:</strong> Regulations mandate tracking internal dose to ensure limits are not exceeded.</li>
                        <li><strong>To inform medical treatment:</strong> Knowing the internal dose helps medical professionals decide on and evaluate treatments.</li>
                        <li><strong>As a "last line of defense":</strong> It helps confirm that safety controls are working effectively.</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="concepts" class="content-section">
            <div class="bg-white p-8 rounded-lg shadow">
                <h2 class="text-3xl font-bold mb-4 text-amber-700">Key Quantities & Units</h2>
                <p class="text-lg mb-6">Understanding the language of internal dosimetry is half the battle. This section covers the fundamental terminology. Click on any card to learn more about the concept.</p>
                <div id="concepts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            </div>
        </section>

        <section id="models" class="content-section">
            <div class="bg-white p-8 rounded-lg shadow">
                <h2 class="text-3xl font-bold mb-4 text-amber-700">Biokinetic Models: The "Why"</h2>
                <p class="text-lg mb-6">Biokinetic models are simplified mathematical representations of how a radionuclide moves through and is retained within the body. They are essential for predicting radionuclide behavior and calculating the total number of disintegrations in an organ over time. This section provides visual explanations of these crucial concepts.</p>
                
                <div class="border-b-2 border-stone-200 mb-4">
                    <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                        <a href="#" class="model-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg active" data-model="compartmental">Compartmental Basics</a>
                        <a href="#" class="model-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-model="icrp30-resp">ICRP 30 Respiratory</a>
                        <a href="#" class="model-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-model="icrp30-gi">ICRP 30 GI Tract</a>
                        <a href="#" class="model-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-model="icrp60-68">ICRP 60 (68) Models</a>
                        <a href="#" class="model-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" data-model="oir-130">OIR Series (ICRP 130)</a>
                    </nav>
                </div>

                <div id="model-compartmental" class="model-content active">
                    <h3 class="text-2xl font-semibold mt-6 mb-2">Visualizing Compartmental Models</h3>
                    <p class="mb-4">The fundamental assumption is <strong>First-Order Kinetics</strong>: the rate a radionuclide leaves a compartment is proportional to the amount present. Think of it like a leaky bucket. The animation below demonstrates this flow.</p>
                    <div class="flex justify-center items-center space-x-4 mb-4">
                        <button id="catenary-btn" class="bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700">Catenary Flow</button>
                        <button id="recycling-btn" class="bg-stone-500 text-white px-4 py-2 rounded-md hover:bg-stone-600">Recycling Flow</button>
                        <button id="reset-anim-btn" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500">Reset</button>
                    </div>
                    <div id="animation-container" class="relative w-full h-64 border border-stone-300 rounded-lg p-4 bg-stone-50 flex items-center justify-around">
                        <div id="compA" class="relative w-32 h-32 bg-blue-200 border-2 border-blue-500 rounded-md flex items-center justify-center font-bold text-blue-800">A</div>
                        <div id="compB" class="relative w-32 h-32 bg-green-200 border-2 border-green-500 rounded-md flex items-center justify-center font-bold text-green-800">B</div>
                        <div id="compC" class="relative w-32 h-32 bg-purple-200 border-2 border-purple-500 rounded-md flex items-center justify-center font-bold text-purple-800">C</div>
                    </div>
                </div>

                <div id="model-icrp30-resp" class="model-content">
                    <h3 class="text-2xl font-semibold mt-6 mb-2">ICRP 30 Respiratory Tract Model</h3>
                    <p class="mb-4">This model describes how inhaled particles deposit in and are cleared from different regions of the respiratory tract. Clearance can be rapid (to the GI tract) or slow (absorption to blood). The model uses <strong>Inhalation Classes (D, W, Y)</strong> to categorize materials by their retention time in the lung: Days, Weeks, or Years.</p>
                    <div class="p-4 bg-stone-50 rounded-lg border">
                        <div class="grid grid-cols-3 gap-4 text-center text-sm">
                            <div class="col-span-3 p-2 bg-red-100 border border-red-300 rounded">Inhalation</div>
                            <div class="p-2 bg-blue-100 border border-blue-300 rounded">N-P Region</div>
                            <div class="p-2 bg-blue-100 border border-blue-300 rounded">T-B Region</div>
                            <div class="p-2 bg-blue-100 border border-blue-300 rounded">P Region</div>
                            <div class="col-span-3 p-2 bg-green-100 border border-green-300 rounded">GI Tract (via mucociliary clearance)</div>
                            <div class="col-span-3 p-2 bg-yellow-100 border border-yellow-300 rounded">Blood (via absorption)</div>
                            <div class="col-start-3 p-2 bg-purple-100 border border-purple-300 rounded">Lymph Nodes</div>
                        </div>
                    </div>
                </div>

                <div id="model-icrp30-gi" class="model-content">
                    <h3 class="text-2xl font-semibold mt-6 mb-2">ICRP 30 GI Tract Model</h3>
                    <p class="mb-4">This model describes the movement of ingested radionuclides through the digestive system. The key parameter is <strong>f₁ (absorption fraction)</strong>, which represents the fraction of a radionuclide absorbed from the small intestine into the bloodstream.</p>
                     <div class="p-4 bg-stone-50 rounded-lg border flex flex-col items-center space-y-2">
                        <div class="p-2 w-1/2 text-center bg-red-100 border border-red-300 rounded">Ingestion</div>
                        <div class="text-2xl font-bold">&darr;</div>
                        <div class="p-2 w-1/2 text-center bg-blue-100 border border-blue-300 rounded">Stomach (ST)</div>
                        <div class="text-2xl font-bold">&darr;</div>
                        <div class="p-2 w-1/2 text-center bg-blue-100 border border-blue-300 rounded relative">Small Intestine (SI) <span class="absolute right-2 top-1/2 -translate-y-1/2 text-yellow-600 font-bold">&rarr; Blood (f₁)</span></div>
                        <div class="text-2xl font-bold">&darr;</div>
                        <div class="p-2 w-1/2 text-center bg-blue-100 border border-blue-300 rounded">Upper Large Intestine (ULI)</div>
                        <div class="text-2xl font-bold">&darr;</div>
                        <div class="p-2 w-1/2 text-center bg-blue-100 border border-blue-300 rounded">Lower Large Intestine (LLI)</div>
                         <div class="text-2xl font-bold">&darr;</div>
                        <div class="p-2 w-1/2 text-center bg-green-100 border border-green-300 rounded">Excretion</div>
                    </div>
                </div>

                <div id="model-icrp60-68" class="model-content">
                    <h3 class="text-2xl font-semibold mt-6 mb-2">ICRP 60 (68) Models: Advancements</h3>
                    <p class="mb-4">ICRP Publication 68 (1994) built upon ICRP 60 (1990 Recommendations), introducing significant changes in radiation protection philosophy and quantities. These models provided more detailed and element-specific approaches.</p>
                    <div class="prose max-w-none">
                        <h4 class="text-xl font-semibold mt-4 mb-2">Key Features:</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Provided dose coefficients (Sv/Bq).</li>
                            <li>Adopted revised quantities from ICRP 60 (e.g., "equivalent dose" instead of "dose equivalent," "effective dose" instead of "effective dose equivalent").</li>
                            <li>Incorporated the revised <strong>Human Respiratory Tract Model (HRTM) from ICRP 66</strong>.</li>
                            <li>Introduced more complex and element-specific systemic models.</li>
                            <li>Addressed urinary and fecal excretion pathways more explicitly.</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-4 mb-2">ICRP 66 Human Respiratory Tract Model (HRTM):</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Advancement:</strong> Moved beyond the simpler ICRP 30 model by considering morphology (structure) as well as mathematical properties. It's a more detailed model of particle deposition and clearance.</li>
                            <li><strong>Absorption Types (F, M, S):</strong> Replaced D, W, Y classes, providing more detailed absorption parameters (fast and slow dissolution rates, bound fractions). Absorption can occur from virtually every compartment.</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-4 mb-2">Revised Systemic Models:</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Increased Complexity:</strong> Introduced more compartments within organs (e.g., liver divided into Liver 1 and Liver 2) and more detailed pathways for specific elements (e.g., separate models for alkaline earths, actinides, iron, calcium, iodine). This led to models with dozens of compartments, often involving recycling.</li>
                            <li><strong>Examples:</strong> ICRP 67 for actinides (Pu, Am, Cm), ICRP 69 for Fe, ICRP 71 for Ca.</li>
                        </ul>
                    </div>
                </div>

                <div id="model-oir-130" class="model-content">
                    <h3 class="text-2xl font-semibold mt-6 mb-2">OIR Series (ICRP Publication 130 Models): The Latest</h3>
                    <p class="mb-4">The Occupational Intakes of Radionuclides (OIR) series, starting with ICRP Publication 130 (2015), represents the latest comprehensive update, incorporating the most recent scientific understanding and updated parameters.</p>
                    <div class="prose max-w-none">
                        <h4 class="text-xl font-semibold mt-4 mb-2">Key Features:</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Provides updated dosimetric data and dose coefficients.</li>
                            <li>Incorporates the latest scientific understanding and revised parameters from other ICRP publications.</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-4 mb-2">Updated Parameters:</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>ICRP 89:</strong> Anatomic and physiological parameters (updated reference man/woman).</li>
                            <li><strong>ICRP 100:</strong> Revised Alimentary Tract Model (HATM), allowing transfer between compartment contents and walls.</li>
                            <li><strong>ICRP 103:</strong> Revised tissue weighting factors (e.g., colon, lung, stomach, breast, remainder now all have $W_T = 0.12$).</li>
                            <li><strong>ICRP 107:</strong> Updated decay data for radionuclides.</li>
                            <li><strong>ICRP 110:</strong> New reference phantoms for absorbed fractions, leading to sex-averaging of effective dose.</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-4 mb-2">HRTM and Absorption Model Refinements:</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li>While ICRP 66 was a major step, the HRTM was further refined in ICRP 130, sometimes even reducing the number of compartments for simplification while improving accuracy.</li>
                            <li>The absorption model (Type F, M, S) was also refined, with an alternate form from ICRP 66 becoming the default, detailing rapid and slow dissolution, and bound material.</li>
                        </ul>
                        <h4 class="text-xl font-semibold mt-4 mb-2">Elemental Data:</h4>
                        <ul class="list-disc list-inside space-y-2">
                            <li>The OIR series provides comprehensive elemental data, including chemical forms, HRTM/HATM absorption parameters, systemic models, individual monitoring considerations, dose coefficients, and intake retention fractions.</li>
                        </ul>
                    </div>
                </div>

            </div>
        </section>

        <section id="calculation" class="content-section">
            <div class="bg-white p-8 rounded-lg shadow">
                <h2 class="text-3xl font-bold mb-4 text-amber-700">The Dose Calculation: The "How"</h2>
                <p class="text-lg mb-6">The Dose Coefficient (DCF) is the bridge between intake and dose. It's calculated using a formula that combines the number of disintegrations in source organs with the energy deposited in target organs. Click on the highlighted terms below to see what they mean.</p>
                
                <div class="bg-stone-100 p-4 rounded-lg text-center mb-6">
                    <p class="text-xl font-mono interactive-formula">
                        H<sub>50,T</sub> = (Constant) &times; &Sigma;<sub>S</sub> [ <span data-term="U_S">U<sub>S</sub></span> &times; <span data-term="SEE">SEE(T &larr; S)</span> ]
                    </p>
                </div>

                <div id="formula-explanation" class="prose max-w-none bg-amber-50 border border-amber-200 p-4 rounded-lg hidden">
                    <h4 id="explanation-title" class="text-xl font-semibold text-amber-800"></h4>
                    <p id="explanation-text"></p>
                    <div id="explanation-details" class="text-sm mt-2"></div>
                </div>

                <h3 class="text-2xl font-semibold mt-8 mb-2">Visualizing Dose Contribution</h3>
                <p class="mb-4">This chart demonstrates how different source organs contribute to the total committed dose of a single target organ for a hypothetical intake of Cobalt-60 (based on ICRP 30 data). This illustrates the importance of knowing where a radionuclide goes in the body.</p>
                <div class="chart-container">
                    <canvas id="doseContributionChart"></canvas>
                </div>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const conceptsData = [
                { term: 'Intake', definition: 'The total amount of radioactive material that enters the body (e.g., by breathing it in, eating it, or through a wound).' },
                { term: 'Uptake', definition: 'The amount of radioactive material that actually gets absorbed into the bloodstream from the respiratory or gastrointestinal tracts. If the intake is directly into the bloodstream (e.g., injection), then intake equals uptake.' },
                { term: 'Deposition', definition: 'The amount of radioactive material initially deposited in a specific organ or tissue.' },
                { term: 'Absorbed Dose (D)', definition: 'The amount of energy absorbed by a unit mass of tissue. It\'s about the physical energy deposited. Unit: Gray (Gy).' },
                { term: 'Equivalent Dose (H_T)', definition: 'The absorbed dose (D) adjusted for the type of radiation, using a Radiation Weighting Factor (W_R). Different radiation types cause different amounts of biological damage. Unit: Sievert (Sv).' },
                { term: 'Effective Dose (E)', definition: 'The equivalent dose (H_T) adjusted for the sensitivity of different organs, using a Tissue Weighting Factor (W_T). It represents the overall risk. Unit: Sievert (Sv).' },
                { term: 'Committed Dose (E(50))', definition: 'The total effective dose that a person is "committed" to receiving over 50 years from a single intake of radioactive material.' },
                { term: 'Annual Limit on Intake (ALI)', definition: 'The maximum amount of a radionuclide a worker can take in a year without exceeding dose limits. Unit: Becquerel (Bq).' },
                { term: 'Derived Air Concentration (DAC)', definition: 'The concentration of a radionuclide in the air that, if breathed for a working year, would result in one ALI. Unit: Bq/m³.' }
            ];

            const conceptsGrid = document.getElementById('concepts-grid');
            conceptsData.forEach(concept => {
                const card = document.createElement('div');
                card.className = 'concept-card bg-stone-50 p-4 rounded-lg border border-stone-200';
                card.innerHTML = `<h3 class="text-xl font-semibold text-stone-700">${concept.term}</h3><p class="text-stone-600 mt-2 hidden">${concept.definition}</p>`;
                card.addEventListener('click', () => {
                    const definition = card.querySelector('p');
                    definition.classList.toggle('hidden');
                });
                conceptsGrid.appendChild(card);
            });

            const navLinks = document.querySelectorAll('.nav-link');
            const mobileNav = document.getElementById('mobile-nav');
            const contentSections = document.querySelectorAll('.content-section');

            function setActiveSection(sectionId) {
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.id === `nav-${sectionId}`);
                });
                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === sectionId);
                });
                if (mobileNav.value !== sectionId) {
                    mobileNav.value = sectionId;
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.target.id.replace('nav-', '');
                    setActiveSection(sectionId);
                });
            });

            mobileNav.addEventListener('change', (e) => {
                setActiveSection(e.target.value);
            });

            const formulaTerms = document.querySelectorAll('.interactive-formula span');
            const explanationBox = document.getElementById('formula-explanation');
            const explanationTitle = document.getElementById('explanation-title');
            const explanationText = document.getElementById('explanation-text');
            const explanationDetails = document.getElementById('explanation-details');

            const formulaExplanations = {
                'U_S': {
                    title: 'U_S: Ultimate Number of Disintegrations',
                    text: 'This represents the total number of nuclear transformations (disintegrations) that occur in a specific source organ (S) over the 50-year commitment period from a 1 Bq intake.',
                    details: 'It tells us *how long* a radionuclide stays in an organ and *how much* it decays there. It is calculated using biokinetic models. The "Skrable\'s Dragon" concept is a mathematical solution for calculating U_S in linear (catenary) systems.'
                },
                'SEE': {
                    title: 'SEE(T ← S): Specific Effective Energy',
                    text: 'The amount of energy deposited in a target organ (T) per unit mass, for each nuclear transformation occurring in a source organ (S).',
                    details: 'It accounts for: <strong>Y (Yield)</strong>, <strong>E (Energy)</strong>, <strong>AF (Absorbed Fraction)</strong>, <strong>Q (Quality Factor)</strong>, and <strong>M (Mass of Target Organ)</strong>. In short, it tells us *where* the energy goes and *how effective* it is at causing damage.'
                }
            };

            formulaTerms.forEach(term => {
                term.addEventListener('click', () => {
                    const termKey = term.dataset.term;
                    const explanation = formulaExplanations[termKey];
                    explanationTitle.textContent = explanation.title;
                    explanationText.textContent = explanation.text;
                    explanationDetails.innerHTML = explanation.details;
                    explanationBox.classList.remove('hidden');
                });
            });

            const modelTabs = document.querySelectorAll('.model-tab');
            const modelContents = document.querySelectorAll('.model-content');
            modelTabs.forEach(tab => {
                tab.addEventListener('click', e => {
                    e.preventDefault();
                    modelTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const modelId = `model-${tab.dataset.model}`;
                    modelContents.forEach(content => {
                        content.classList.toggle('active', content.id === modelId);
                    });
                });
            });

            let animationInterval = null;
            const animContainer = document.getElementById('animation-container');
            const compA = document.getElementById('compA');
            const compB = document.getElementById('compB');
            const compC = document.getElementById('compC');

            let compARect, compBRect, compCRect;

            function updateBoxRects() {
                const animContainerRect = animContainer.getBoundingClientRect();
                
                compARect = { 
                    x: compA.offsetLeft, 
                    y: compA.offsetTop, 
                    width: compA.offsetWidth, 
                    height: compA.offsetHeight 
                };
                compBRect = { 
                    x: compB.offsetLeft, 
                    y: compB.offsetTop, 
                    width: compB.offsetWidth, 
                    height: compB.offsetHeight 
                };
                compCRect = { 
                    x: compC.offsetLeft, 
                    y: compC.offsetTop, 
                    width: compC.offsetWidth, 
                    height: compC.offsetHeight 
                };
            }

            window.addEventListener('resize', updateBoxRects);

            function getRandomPosInBox(boxRect) {
                return {
                    left: boxRect.x + Math.random() * (boxRect.width - 10),
                    top: boxRect.y + Math.random() * (boxRect.height - 10)
                };
            }

            function resetAnimation() {
                if (animationInterval) clearInterval(animationInterval);
                animContainer.querySelectorAll('.particle').forEach(p => p.remove());
                updateBoxRects();
            }

            function startAnimation(type) {
                resetAnimation();
                updateBoxRects();

                let particles = [];
                for (let i = 0; i < 20; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    const initialPos = getRandomPosInBox(compARect);
                    p.style.left = `${initialPos.left}px`;
                    p.style.top = `${initialPos.top}px`;
                    animContainer.appendChild(p);
                    particles.push({ el: p, state: 'A', timer: Math.random() * 5, delay: i * 0.2 });
                }

                animationInterval = setInterval(() => {
                    particles.forEach(p => {
                        if (p.delay > 0) {
                            p.delay -= 0.1;
                            return;
                        }

                        p.timer -= 0.1;
                        if (p.timer <= 0) {
                            let targetRect;
                            let newState;

                            if (p.state === 'A') {
                                newState = 'B';
                                targetRect = compBRect;
                            } else if (p.state === 'B') {
                                if (type === 'catenary') {
                                    newState = 'C';
                                    targetRect = compCRect;
                                } else { // recycling
                                    if (Math.random() < 0.2) { // 20% chance to go to C (exit), 80% chance to recycle to A
                                        newState = 'C';
                                        targetRect = compCRect;
                                    } else {
                                        newState = 'A';
                                        targetRect = compARect;
                                    }
                                }
                            } else if (p.state === 'C') {
                                newState = 'Done';
                                p.el.remove();
                                return;
                            }

                            if (newState !== 'Done') {
                                p.state = newState;
                                p.timer = 3 + Math.random() * 4;
                                const newPos = getRandomPosInBox(targetRect);
                                p.el.style.left = `${newPos.left}px`;
                                p.el.style.top = `${newPos.top}px`;
                            }
                        }
                    });
                    particles = particles.filter(p => p.state !== 'Done');
                }, 100);
            }
            
            document.getElementById('catenary-btn').addEventListener('click', () => startAnimation('catenary'));
            document.getElementById('recycling-btn').addEventListener('click', () => startAnimation('recycling'));
            document.getElementById('reset-anim-btn').addEventListener('click', resetAnimation);

            updateBoxRects();


            const ctx = document.getElementById('doseContributionChart').getContext('2d');
            const doseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Lungs', 'Stomach', 'Small Intestine', 'ULI', 'LLI', 'Liver', 'Total Body'],
                    datasets: [{
                        label: 'Relative Dose Contribution to Lungs from Co-60',
                        data: [360, 0.008, 0.005, 0.006, 0.001, 0.019, 0.012],
                        backgroundColor: [
                            'rgba(217, 119, 6, 0.6)',
                            'rgba(234, 179, 8, 0.6)',
                            'rgba(161, 98, 7, 0.6)',
                            'rgba(101, 163, 13, 0.6)',
                            'rgba(22, 163, 74, 0.6)',
                            'rgba(5, 150, 105, 0.6)',
                            'rgba(13, 148, 136, 0.6)'
                        ],
                        borderColor: [
                            'rgba(217, 119, 6, 1)',
                            'rgba(234, 179, 8, 1)',
                            'rgba(161, 98, 7, 1)',
                            'rgba(101, 163, 13, 1)',
                            'rgba(22, 163, 74, 1)',
                            'rgba(5, 150, 105, 1)',
                            'rgba(13, 148, 136, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Relative Dose (Arbitrary Units)'
                            }
                        },
                        y: {
                           ticks: {
                                autoSkip: false
                           }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Source Organ Contribution to Lung Dose (Co-60)',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += context.parsed.x.toExponential(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

        });
    </script>
</body>
</html>
